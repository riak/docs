
<h2 id="using-causal-context">Using Causal Context</h2>

<p>If an object already exists under a certain key and you want to write a
new object to that key, Riak needs to know what to do, especially if
multiple writes are happening at the same time. Which of the objects
being written should be deemed correct? These kinds of scenarios can
arise quite frequently in distributed, <a href="/riak/kv/2.1.1/learn/concepts/eventual-consistency">eventually consistent</a> systems.</p>

<p>Riak decides which object to choose in case of conflict using <a href="/riak/kv/2.1.1/learn/concepts/causal-context">causal context</a>. These objects track the causal history of objects.
They are attached to <em>all</em> Riak objects as metadata, and they are not
readable by humans. They may sound complex—and they are fairly complex
behind the scenes—but using them in your application is very simple.</p>

<p>Using causal context in an update would involve the following steps;</p>

<ol>
  <li>Fetch the object</li>
  <li>Modify the object’s value (without modifying the fetched <a href="/riak/kv/2.1.1/learn/concepts/causal-context">context object</a></li>
  <li>Write the new object to Riak</li>
</ol>

<p>Step 2 is the most important here. All of Basho’s official Riak clients
enable you to modify an object’s value without modifying its <a href="/riak/kv/2.1.1/learn/concepts/causal-context">causal context</a>. Although a more detailed tutorial on context objects and
object updates can be found in <a href="/riak/kv/2.1.1/developing/usage/conflict-resolution">Conflict Resolution</a>, we’ll walk you
through a basic example here.</p>

<p>Let’s say that the current NBA champion is the Washington Generals.
We’ve stored that data in Riak under the key <code class="language-plaintext highlighter-rouge">champion</code> in the bucket
<code class="language-plaintext highlighter-rouge">nba</code>, which bears the bucket type <code class="language-plaintext highlighter-rouge">sports</code>. The value of the object is
a simple text snippet that says <code class="language-plaintext highlighter-rouge">Washington Generals</code>.</p>

<p>But one day the Harlem Globetrotters enter the league and dethrone the
hapless Generals (forever, as it turns out). Because we want our Riak
database to reflect this new development in the league, we want to make
a new write to the <code class="language-plaintext highlighter-rouge">champion</code> key. Let’s read the object stored there
and modify the value.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Location</span> <span class="n">currentChampion</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Location</span><span class="o">(</span><span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">"sports"</span><span class="o">,</span> <span class="s">"nba"</span><span class="o">),</span> <span class="s">"champion"</span><span class="o">);</span>
<span class="nc">FetchValue</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchValue</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">currentChampion</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchValue</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="nc">RiakObject</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="nc">RiakObject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">obj</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="nc">BinaryValue</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"Harlem Globetrotters"</span><span class="o">))</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span><span class="p">(</span><span class="s1">'sports'</span><span class="p">).</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'nba'</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'champion'</span><span class="p">)</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">raw_data</span> <span class="o">=</span> <span class="s1">'Harlem Globetrotters'</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">store</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Location</span><span class="p">(</span><span class="s1">'champion'</span><span class="p">,</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Bucket</span><span class="p">(</span><span class="s1">'nba'</span><span class="p">,</span> <span class="s1">'sports'</span><span class="p">));</span>
<span class="nv">$object</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\FetchObject</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">getObject</span><span class="p">();</span>

<span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">setData</span><span class="p">(</span><span class="s1">'Harlem Globetrotters'</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\StoreObject</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">withObject</span><span class="p">(</span><span class="nv">$object</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s">'sports'</span><span class="p">).</span><span class="n">bucket</span><span class="p">(</span><span class="s">'nba'</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'champion'</span><span class="p">)</span>
<span class="n">obj</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">'Harlem Globetrotters'</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakObjectId</span><span class="p">(</span><span class="s">"sports"</span><span class="p">,</span> <span class="s">"nba"</span><span class="p">,</span> <span class="s">"champion"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakObject</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">"Washington Generals"</span><span class="p">,</span>
    <span class="n">RiakConstants</span><span class="p">.</span><span class="n">ContentTypes</span><span class="p">.</span><span class="n">TextPlain</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

<span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">obj</span> <span class="p">=</span> <span class="n">rslt</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">SetObject</span><span class="p">(</span><span class="s">"Harlem Globetrotters"</span><span class="p">,</span>
    <span class="n">RiakConstants</span><span class="p">.</span><span class="n">ContentTypes</span><span class="p">.</span><span class="n">TextPlain</span><span class="p">);</span>
<span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">riakObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">KV</span><span class="p">.</span><span class="nx">RiakObject</span><span class="p">();</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setContentType</span><span class="p">(</span><span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">Washington Generals</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sports</span><span class="dl">'</span><span class="p">,</span> <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">nba</span><span class="dl">'</span><span class="p">,</span> <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">champion</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">value</span><span class="p">:</span> <span class="nx">riakObj</span>
<span class="p">};</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">storeValue</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">fetchValue</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">fetchedObj</span> <span class="o">=</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="nx">fetchedObj</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">Harlem Globetrotters</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">fetchedObj</span><span class="p">;</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">returnBody</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">storeValue</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">updatedObj</span> <span class="o">=</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">champion: %s</span><span class="dl">"</span><span class="p">,</span> <span class="nx">updatedObj</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">));</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">%% In the Erlang client, you cannot view a context objectdirectly, but it
%% will be included in the output when you fetch an object:
</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Obj</span><span class="p">}</span> <span class="o">=</span> <span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span>
                                <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"sports"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"nba"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                                <span class="o">&lt;&lt;</span><span class="s">"champion"</span><span class="o">&gt;&gt;</span><span class="p">),</span>
<span class="nv">UpdatedObj</span> <span class="o">=</span> <span class="nn">riakc_obj</span><span class="p">:</span><span class="nf">update_value</span><span class="p">(</span><span class="nv">Obj</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"Harlem Globetrotters"</span><span class="o">&gt;&gt;</span><span class="p">),</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">NewestObj</span><span class="p">}</span> <span class="o">=</span> <span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">UpdatedObj</span><span class="p">,</span> <span class="p">[</span><span class="n">return_body</span><span class="p">]).</span>
</code></pre></div></div>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obj</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">riak</span><span class="o">.</span><span class="n">Object</span><span class="p">{</span>
    <span class="n">ContentType</span><span class="o">:</span>     <span class="s">"text/plain"</span><span class="p">,</span>
    <span class="n">Charset</span><span class="o">:</span>         <span class="s">"utf-8"</span><span class="p">,</span>
    <span class="n">ContentEncoding</span><span class="o">:</span> <span class="s">"utf-8"</span><span class="p">,</span>
    <span class="n">Value</span><span class="o">:</span>           <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Washington Generals"</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">cmd</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">riak</span><span class="o">.</span><span class="n">NewStoreValueCommandBuilder</span><span class="p">()</span><span class="o">.</span>
    <span class="n">WithBucketType</span><span class="p">(</span><span class="s">"sports"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithBucket</span><span class="p">(</span><span class="s">"nba"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithKey</span><span class="p">(</span><span class="s">"champion"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithContent</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithReturnBody</span><span class="p">(</span><span class="no">true</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Build</span><span class="p">()</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="n">svc</span> <span class="o">:=</span> <span class="n">cmd</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">riak</span><span class="o">.</span><span class="n">StoreValueCommand</span><span class="p">)</span>
<span class="n">rsp</span> <span class="o">:=</span> <span class="n">svc</span><span class="o">.</span><span class="n">Response</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Values</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
<span class="n">obj</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Harlem Globetrotters"</span><span class="p">)</span>

<span class="n">cmd</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">riak</span><span class="o">.</span><span class="n">NewStoreValueCommandBuilder</span><span class="p">()</span><span class="o">.</span>
    <span class="n">WithBucketType</span><span class="p">(</span><span class="s">"sports"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithBucket</span><span class="p">(</span><span class="s">"nba"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithKey</span><span class="p">(</span><span class="s">"champion"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithContent</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithReturnBody</span><span class="p">(</span><span class="no">true</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Build</span><span class="p">()</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="n">svc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">riak</span><span class="o">.</span><span class="n">StoreValueCommand</span><span class="p">)</span>
<span class="n">rsp</span> <span class="o">=</span> <span class="n">svc</span><span class="o">.</span><span class="n">Response</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Values</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"champion: %v"</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">Value</span><span class="p">))</span>
</code></pre></div></div>

<pre><code class="language-curl"># When using curl, the context object is attached to the X-Riak-Vclock header

curl -i http://localhost:8098/types/sports/buckets/nba/keys/champion

# In the resulting output, the header will look something like this:

X-Riak-Vclock: a85hYGBgzGDKBVIcWu/1S4OVPaIymBIZ81gZbskuOMOXBQA=

# When performing a write to the same key, that same header needs to
# accompany the write for Riak to be able to use the context object
</code></pre>

<p>In the samples above, we didn’t need to actually interact with the
context object, as retaining and passing along the context object was
accomplished automatically by the client. If, however, you do need
access to an object’s context, the clients enable you to fetch it from
the object:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using the RiakObject obj from above:</span>

<span class="nc">Vclock</span> <span class="n">vClock</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getVclock</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">vClock</span><span class="o">.</span><span class="na">asString</span><span class="o">());</span>

<span class="c1">// The context object will look something like this:</span>
<span class="c1">// a85hYGBgzGDKBVIcWu/1S4OVPaIymBIZ81gZbskuOMOXBQA=</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Using the RObject obj from above:</span>

<span class="n">obj</span><span class="p">.</span><span class="nf">vclock</span>

<span class="c1"># The context object will look something like this:</span>
<span class="c1"># a85hYGBgzGDKBVIcWu/1S4OVPaIymBIZ81gZbskuOMOXBQA=</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Using the RObject obj from above:</span>

<span class="k">echo</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">getVclock</span><span class="p">();</span> <span class="c1">// a85hYGBgzGDKBVIcWu/1S4OVPaIymBIZ81gZbskuOMOXBQA=</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Using the RiakObject obj from above:
</span>
<span class="n">obj</span><span class="p">.</span><span class="n">vclock</span>

<span class="c1"># The context object will look something like this:
# a85hYGBgzGDKBVIcWu/1S4OVPaIymBIZ81gZbskuOMOXBQA=
</span></code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using the RiakObject obj from above:</span>
<span class="kt">var</span> <span class="n">vclock</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">VectorClock</span><span class="p">;</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">vclock</span><span class="p">));</span>

<span class="c1">// The output will look something like this:</span>
<span class="c1">// a85hYGBgzGDKBVIcWu/1S4OVPaIymBIZ81gZbskuOMOXBQA=</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using the RiakObject fetchedObj from above:</span>
<span class="kd">var</span> <span class="nx">fetchedObj</span> <span class="o">=</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">vclock: %s</span><span class="dl">"</span><span class="p">,</span> <span class="nx">fetchedObj</span><span class="p">.</span><span class="nx">getVClock</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">// The output will look something like this:</span>
<span class="c1">// vclock: a85hYGBgymDKBVIcR4M2cov1HeHKYEpkymNlsE2cfo4PKjXXjuOU+FHdWqAUM1CqECSVBQA=</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">%% Using the Obj object from above:
</span>
<span class="nn">riakc_obj</span><span class="p">:</span><span class="nf">vclock</span><span class="p">(</span><span class="nv">Obj</span><span class="p">).</span>

<span class="c">%% The context object will look something like this in the Erlang shell:
%% &lt;&lt;107,206,97,96,96,96,204,96,202,5,82,28,202,156,255,126,
%% 6,175,157,255,57,131,41,145,49,143,149,225,240,...&gt;&gt;
</span></code></pre></div></div>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">svc</span> <span class="o">:=</span> <span class="n">cmd</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">riak</span><span class="o">.</span><span class="n">StoreValueCommand</span><span class="p">)</span>
<span class="n">rsp</span> <span class="o">:=</span> <span class="n">svc</span><span class="o">.</span><span class="n">Response</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">rsp</span><span class="o">.</span><span class="n">VClock</span><span class="p">)</span>

<span class="c">// Output:</span>
<span class="c">// X3hNXFq3ythUqvvrG9eJEGbUyLS</span>
</code></pre></div></div>

<h2 id="the-object-update-cycle">The Object Update Cycle</h2>

<p>If you decide that your application requires mutable data in Riak, we
recommend that you:</p>

<ul>
  <li>avoid high-frequency object updates to the same key (i.e. multiple
updates per second for long periods of time), as this will degrade
Riak performance; and that you</li>
  <li>follow a read-modify-write cycle when performing updates.</li>
</ul>

<p>That cycle looks something like this:</p>

<ol>
  <li><strong>Read</strong> the object from Riak. This step is important for updates
because this enables you to fetch the object’s <a href="/riak/kv/2.1.1/learn/concepts/causal-context">causal context</a>, which
is the information that Riak uses to make decisions about which object
values are most recent (this is especially useful for objects that are
frequently updated). This context object needs to be passed back to Riak
when you update the object. This step is handled for you by Basho’s
client libraries as long as you perform a read prior to an update. In
addition, if you have chosen to allow Riak to generate
<a href="/riak/kv/2.1.1/developing/usage/conflict-resolution/#siblings">siblings</a> (which we recommend), you
should <strong>resolve sibling conflicts</strong> upon read if they exist. For more
on this, please see our documentation on <a href="/riak/kv/2.1.1/developing/usage/conflict-resolution">conflict resolution</a>, along
with examples from our official client libraries:
    <ul>
      <li><a href="/riak/kv/2.1.1/developing/usage/conflict-resolution/java">Java</a></li>
      <li><a href="/riak/kv/2.1.1/developing/usage/conflict-resolution/ruby">Ruby</a></li>
      <li><a href="/riak/kv/2.1.1/developing/usage/conflict-resolution/python">Python</a></li>
      <li><a href="/riak/kv/2.1.1/developing/usage/conflict-resolution/csharp">C#</a></li>
      <li><a href="/riak/kv/2.1.1/developing/usage/conflict-resolution/golang">Go</a></li>
    </ul>
  </li>
  <li><strong>Modify the object</strong> on the application side.</li>
  <li><strong>Write</strong> the new, modified object to Riak. Because you read the
object first, Riak will receive the object’s causal context metadata.
Remember that this happens automatically.</li>
</ol>

<p>In general, you should read an object before modifying it. Think of it
as performing a <code class="language-plaintext highlighter-rouge">GET</code> prior to any <code class="language-plaintext highlighter-rouge">PUT</code> when interacting with a REST
API.</p>

<blockquote>
  <p><strong>Note on strong consistency</strong></p>

  <p>If you are using Riak’s <a href="/riak/kv/2.1.1/developing/app-guide/strong-consistency/">strong consistency</a> feature, it is not only desirable but also necessary to use the read/modify/write cycle explained in the section above. If you attempt to update an object without fetching the object first, your update operation will necessarily fail. More information can be found in the
<a href="/riak/kv/2.1.1/developing/app-guide/strong-consistency/#strongly-consistent-writes">strong consistency documentation</a>.</p>
</blockquote>

<h3 id="updating-deleted-objects">Updating Deleted Objects</h3>

<p>You should use the read-modify-write cycle explained above at all times,
<em>even if you’re updating deleted objects</em>. The reasons for that can be
found in our documentation on <a href="/riak/kv/2.1.1/using/reference/object-deletion/#tombstones">tombstones</a>.</p>

<p>There are some modifications that you may need to make if you are
updating objects that may have been deleted previously. If you are using
the Java client, an explanation and examples are given in the
<a href="#java-client-example">Java-specific section below</a>. If
you are using the Python or Erlang clients, causal context for deleted
objects will be handled automatically. If you are using the Ruby client,
you will need to explicitly set the <code class="language-plaintext highlighter-rouge">deletedvclock</code> parameter to <code class="language-plaintext highlighter-rouge">true</code>
when reading an object, like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'fruits'</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'banana'</span><span class="p">,</span> <span class="ss">deletedvclock: </span><span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="example-update">Example Update</h2>

<p>In this section, we’ll provide an update example for Basho’s official Ruby,
Python, .NET, Node.js, Erlang and Go clients. Because updates with the official
Java client functions somewhat differently, those examples can be found in the
<a href="#java-client-example">section below</a>.</p>

<p>For our example, imagine that you are storing information about NFL head
coaches in the bucket <code class="language-plaintext highlighter-rouge">coaches</code>, which will bear the bucket type
<code class="language-plaintext highlighter-rouge">siblings</code>, which sets <code class="language-plaintext highlighter-rouge">allow_mult</code> to <code class="language-plaintext highlighter-rouge">true</code>. The key for each object
is the name of the team, e.g. <code class="language-plaintext highlighter-rouge">giants</code>, <code class="language-plaintext highlighter-rouge">broncos</code>, etc. Each object will
consist of the name of the coach in plain text. Here’s an example of
creating and storing such an object:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'coaches'</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="nf">get_or_new</span><span class="p">(</span><span class="s1">'seahawks'</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'siblings'</span><span class="p">)</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">=</span> <span class="s1">'text/plain'</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">raw_data</span> <span class="o">=</span> <span class="s1">'Pete Carroll'</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">store</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Location</span><span class="p">(</span><span class="s1">'seahawks'</span><span class="p">,</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Bucket</span><span class="p">(</span><span class="s1">'coaches'</span><span class="p">,</span> <span class="s1">'siblings'</span><span class="p">));</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\FetchObject</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">isSuccess</span><span class="p">())</span> <span class="p">{</span>
  <span class="nv">$object</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getObject</span><span class="p">();</span>
  <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">setData</span><span class="p">(</span><span class="s1">'Pete Carroll'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nv">$object</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Object</span><span class="p">(</span><span class="s1">'Pete Carroll'</span><span class="p">,</span> <span class="s1">'text/plain'</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\StoreObject</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withObject</span><span class="p">(</span><span class="nv">$object</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s">'siblings'</span><span class="p">).</span><span class="n">bucket</span><span class="p">(</span><span class="s">'coaches'</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">RiakObject</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="s">'seahawks'</span><span class="p">)</span>
<span class="n">obj</span><span class="p">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">'text/plain'</span>
<span class="n">obj</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">'Pete Carroll'</span>
<span class="n">obj</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakObjectId</span><span class="p">(</span><span class="s">"siblings"</span><span class="p">,</span> <span class="s">"coaches"</span><span class="p">,</span> <span class="s">"seahawks"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakObject</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">"Pete Carroll"</span><span class="p">,</span>
    <span class="n">RiakConstants</span><span class="p">.</span><span class="n">ContentTypes</span><span class="p">.</span><span class="n">TextPlain</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">riakObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">KV</span><span class="p">.</span><span class="nx">RiakObject</span><span class="p">();</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setContentType</span><span class="p">(</span><span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setBucketType</span><span class="p">(</span><span class="dl">'</span><span class="s1">siblings</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setBucket</span><span class="p">(</span><span class="dl">'</span><span class="s1">coaches</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">seahawks</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">riakObj</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">Pete Carroll</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">storeValue</span><span class="p">({</span> <span class="na">value</span><span class="p">:</span> <span class="nx">riakObj</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">Stored Pete Carroll</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Obj</span> <span class="o">=</span> <span class="nn">riakc_obj</span><span class="p">:</span><span class="nf">new</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"siblings"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"coaches"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                     <span class="o">&lt;&lt;</span><span class="s">"seahawks"</span><span class="o">&gt;&gt;</span><span class="p">,</span>
                     <span class="o">&lt;&lt;</span><span class="s">"Pete Carroll"</span><span class="o">&gt;&gt;</span><span class="p">,</span>
                     <span class="o">&lt;&lt;</span><span class="s">"text/plain"</span><span class="o">&gt;&gt;</span><span class="p">).</span>
<span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Obj</span><span class="p">).</span>
</code></pre></div></div>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obj</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">riak</span><span class="o">.</span><span class="n">Object</span><span class="p">{</span>
    <span class="n">ContentType</span><span class="o">:</span>     <span class="s">"text/plain"</span><span class="p">,</span>
    <span class="n">Charset</span><span class="o">:</span>         <span class="s">"utf-8"</span><span class="p">,</span>
    <span class="n">ContentEncoding</span><span class="o">:</span> <span class="s">"utf-8"</span><span class="p">,</span>
    <span class="n">Value</span><span class="o">:</span>           <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Pete Carroll"</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">cmd</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">riak</span><span class="o">.</span><span class="n">NewStoreValueCommandBuilder</span><span class="p">()</span><span class="o">.</span>
    <span class="n">WithBucketType</span><span class="p">(</span><span class="s">"siblings"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithBucket</span><span class="p">(</span><span class="s">"coaches"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithKey</span><span class="p">(</span><span class="s">"seahawks"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">WithContent</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Build</span><span class="p">()</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Stored Pete Carroll"</span><span class="p">)</span>
</code></pre></div></div>

<p>Every once in a while, though, head coaches change in the NFL, which
means that our data would need to be updated. Below is an example
function for updating such objects:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_coach</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">new_coach</span><span class="p">)</span>
  <span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'coaches'</span><span class="p">)</span>
  <span class="c1"># The read phase</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="nf">get_or_new</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'siblings'</span><span class="p">)</span>
  <span class="c1"># The modify phase</span>
  <span class="n">obj</span><span class="p">.</span><span class="nf">data</span> <span class="o">=</span> <span class="n">new_coach</span>
  <span class="c1"># The write phase</span>
  <span class="n">obj</span><span class="p">.</span><span class="nf">store</span>
<span class="k">end</span>

<span class="c1"># Example usage</span>
<span class="n">update_coach</span><span class="p">(</span><span class="s1">'packers'</span><span class="p">,</span> <span class="s1">'Vince Lombardi'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">update_coach</span><span class="p">(</span><span class="nv">$team</span><span class="p">,</span> <span class="nv">$coach</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Location</span><span class="p">(</span><span class="s1">'seahawks'</span><span class="p">,</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Bucket</span><span class="p">(</span><span class="s1">'coaches'</span><span class="p">,</span> <span class="s1">'siblings'</span><span class="p">));</span>
  <span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\FetchObject</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">isSuccess</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$object</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getObject</span><span class="p">();</span>
    <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">setData</span><span class="p">(</span><span class="s1">'Pete Carroll'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$object</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Object</span><span class="p">(</span><span class="s1">'Pete Carroll'</span><span class="p">,</span> <span class="s1">'text/plain'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\StoreObject</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">withObject</span><span class="p">(</span><span class="nv">$object</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>

  <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">isSuccess</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nf">update_coach</span><span class="p">(</span><span class="s1">'packers'</span><span class="p">,</span> <span class="s1">'Vince Lombardi'</span><span class="p">);</span> <span class="c1">// true</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_coach</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">new_coach</span><span class="p">):</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s">'siblings'</span><span class="p">).</span><span class="n">bucket</span><span class="p">(</span><span class="s">'coaches'</span><span class="p">)</span>
    <span class="c1"># The read phase
</span>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
    <span class="c1"># The modify phase
</span>    <span class="n">obj</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_coach</span>
    <span class="c1"># The write phase
</span>    <span class="n">obj</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>

<span class="c1"># Example usage
</span><span class="n">update_coach</span><span class="p">(</span><span class="s">'packers'</span><span class="p">,</span> <span class="s">'Vince Lombardi'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateCoach</span><span class="p">(</span><span class="kt">string</span> <span class="n">team</span><span class="p">,</span> <span class="kt">string</span> <span class="n">newCoach</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakObjectId</span><span class="p">(</span><span class="s">"siblings"</span><span class="p">,</span> <span class="s">"coaches"</span><span class="p">,</span> <span class="n">team</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">getResult</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="n">RiakObject</span> <span class="n">obj</span> <span class="p">=</span> <span class="n">getResult</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">obj</span><span class="p">.</span><span class="n">SetObject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">newCoach</span><span class="p">,</span> <span class="n">RiakConstants</span><span class="p">.</span><span class="n">ContentTypes</span><span class="p">.</span><span class="n">TextPlain</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">update_coach</span><span class="p">(</span><span class="nx">team</span><span class="p">,</span> <span class="nx">newCoach</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">fetchValue</span><span class="p">({</span>
        <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">siblings</span><span class="dl">'</span><span class="p">,</span> <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">coaches</span><span class="dl">'</span><span class="p">,</span> <span class="na">key</span><span class="p">:</span> <span class="nx">team</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">riakObj</span> <span class="o">=</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="nx">riakObj</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">newCoach</span><span class="p">);</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">storeValue</span><span class="p">({</span> <span class="na">value</span><span class="p">:</span> <span class="nx">riakObj</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">update_coach</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">new_coach</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Obj</span><span class="p">}</span> <span class="o">=</span> <span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span>
                                    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"siblings"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"coaches"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                                    <span class="o">&lt;&lt;</span><span class="n">team</span><span class="o">&gt;&gt;</span><span class="p">),</span>
    <span class="nv">ModifiedObj</span> <span class="o">=</span> <span class="nn">riakc_obj</span><span class="p">:</span><span class="nf">update_value</span><span class="p">(</span><span class="nv">Obj</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="n">new_coach</span><span class="o">&gt;&gt;</span><span class="p">),</span>
    <span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">ModifiedObj</span><span class="p">).</span>

<span class="c">%% Example usage
</span><span class="nf">update_coach</span><span class="p">(</span><span class="n">'packers'</span><span class="p">,</span> <span class="n">'Vince Lombardi'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">updateCoach</span><span class="p">(</span><span class="n">cluster</span> <span class="o">*</span><span class="n">riak</span><span class="o">.</span><span class="n">Cluster</span><span class="p">,</span> <span class="n">team</span><span class="p">,</span> <span class="n">newCoach</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">cmd</span> <span class="n">riak</span><span class="o">.</span><span class="n">Command</span>
    <span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>

    <span class="n">cmd</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">riak</span><span class="o">.</span><span class="n">NewFetchValueCommandBuilder</span><span class="p">()</span><span class="o">.</span>
        <span class="n">WithBucketType</span><span class="p">(</span><span class="s">"siblings"</span><span class="p">)</span><span class="o">.</span>
        <span class="n">WithBucket</span><span class="p">(</span><span class="s">"coaches"</span><span class="p">)</span><span class="o">.</span>
        <span class="n">WithKey</span><span class="p">(</span><span class="n">team</span><span class="p">)</span><span class="o">.</span>
        <span class="n">Build</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="n">fvc</span> <span class="o">:=</span> <span class="n">cmd</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">riak</span><span class="o">.</span><span class="n">FetchValueCommand</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">:=</span> <span class="n">fvc</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">Values</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="n">newCoach</span><span class="p">)</span>

    <span class="n">cmd</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">riak</span><span class="o">.</span><span class="n">NewStoreValueCommandBuilder</span><span class="p">()</span><span class="o">.</span>
        <span class="n">WithBucketType</span><span class="p">(</span><span class="s">"siblings"</span><span class="p">)</span><span class="o">.</span>
        <span class="n">WithBucket</span><span class="p">(</span><span class="s">"coaches"</span><span class="p">)</span><span class="o">.</span>
        <span class="n">WithKey</span><span class="p">(</span><span class="n">team</span><span class="p">)</span><span class="o">.</span>
        <span class="n">WithContent</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span>
        <span class="n">Build</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the example above, you can see the three steps in action: first, the
object is read, which automatically fetches the object’s causal context;
then the object is modified, i.e. the object’s value is set to the name
of the new coach; and finally the object is written back to Riak.</p>

<h2 id="object-update-anti-patterns">Object Update Anti-patterns</h2>

<p>The most important thing to bear in mind when updating objects is this:
you should always read an object prior to updating it <em>unless</em> you are
certain that no object is stored there. If you are storing <a href="/riak/kv/2.1.1/developing/data-modeling/#sensor-data">sensor data</a> in Riak and using timestamps as keys, for example, then you can be sure that keys are not repeated. In that case, making writes to Riak without first reading the object is fine. If
you’re not certain, however, then we recommend always reading the object
first.</p>

<h2 id="java-client-example">Java Client Example</h2>

<p>As with the other official clients, object updates using the Java client
will automatically fetch the object’s causal context metadata, modify
the object, and then write the modified value back to Riak. You can
update object values by creating your own <code class="language-plaintext highlighter-rouge">UpdateValue</code> operations that
extend the abstract class <code class="language-plaintext highlighter-rouge">Update&lt;T&gt;</code>. An <code class="language-plaintext highlighter-rouge">UpdateValue</code> operation must
have an <code class="language-plaintext highlighter-rouge">apply</code> method that returns a new <code class="language-plaintext highlighter-rouge">T</code>. In our case, the data
class that we’re dealing with is <code class="language-plaintext highlighter-rouge">User</code>. First, let’s create a very
basic <code class="language-plaintext highlighter-rouge">User</code> class:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">hobbies</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">hobbies</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">hobbies</span> <span class="o">=</span> <span class="n">hobbies</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the example below, we’ll create an update value operation called
<code class="language-plaintext highlighter-rouge">UpdateUserName</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.basho.riak.client.api.commands.kv.UpdateValue.Update</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UpdateUserName</span> <span class="kd">extends</span> <span class="nc">Update</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">User</span> <span class="n">original</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// update logic goes here</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the example above, we didn’t specify any actual update logic. Let’s
change that by creating an <code class="language-plaintext highlighter-rouge">UpdateValue</code> operation that changes a <code class="language-plaintext highlighter-rouge">User</code>
object’s <code class="language-plaintext highlighter-rouge">name</code> parameter:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UpdateUserName</span> <span class="kd">extends</span> <span class="nc">Update</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">newUsername</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UpdateUserName</span><span class="o">(</span><span class="nc">String</span> <span class="n">newUsername</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">newUsername</span> <span class="o">=</span> <span class="n">newUsername</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">User</span> <span class="n">original</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">original</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">newUsername</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">original</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, let’s put our <code class="language-plaintext highlighter-rouge">UpdateUserName</code> operation into effect. In the
example below, we’ll change a <code class="language-plaintext highlighter-rouge">User</code> object’s <code class="language-plaintext highlighter-rouge">username</code> from whatever
it currently is to <code class="language-plaintext highlighter-rouge">cliffhuxtable1986</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.basho.riak.client.api.commands.kv.FetchValue</span><span class="o">;</span>

<span class="nc">Location</span> <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Location</span><span class="o">(...);</span>
<span class="nc">UpdateValue</span> <span class="n">updateOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateValue</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">location</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withFetchOption</span><span class="o">(</span><span class="nc">FetchValue</span><span class="o">.</span><span class="na">Option</span><span class="o">.</span><span class="na">DELETED_VCLOCK</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUpdate</span><span class="o">(</span><span class="k">new</span> <span class="nc">UpdateUserName</span><span class="o">(</span><span class="s">"cliffhuxtable1986"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">updateOp</span><span class="o">);</span>
</code></pre></div></div>

<p>You may notice that a fetch option was added to our <code class="language-plaintext highlighter-rouge">UpdateValue</code>
operation: <code class="language-plaintext highlighter-rouge">FetchValue.Option.DELETED_VCLOCK</code> was set to <code class="language-plaintext highlighter-rouge">true</code>.
Remember from the section above that you should always read an object
before modifying and writing it, <em>even if the object has been deleted</em>.
Setting this option to <code class="language-plaintext highlighter-rouge">true</code> ensures that the causal context is fetched
from Riak if the object has been deleted. We recommend always setting
this option to <code class="language-plaintext highlighter-rouge">true</code> when constructing <code class="language-plaintext highlighter-rouge">UpdateValue</code> operations.</p>

<h3 id="clobber-updates">Clobber Updates</h3>

<p>If you’d like to update an object by simply replacing it with an
entirely new value of the same type (unlike in the section above, where
only one property of the object was updated), the Java client provides
you with a “clobber” update that you can use to replace the existing
object with a new object of the same type rather than changing one or
more properties of the object. Imagine that there is a <code class="language-plaintext highlighter-rouge">User</code> object
stored in the bucket <code class="language-plaintext highlighter-rouge">users</code> in the key <code class="language-plaintext highlighter-rouge">cliffhuxtable1986</code>, as in the
example above, and we simply want to replace the object with a brand new
object:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Location</span> <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Location</span><span class="o">(</span><span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">"users"</span><span class="o">),</span> <span class="s">"cliffhuxtable1986"</span><span class="o">);</span>
<span class="nc">User</span> <span class="n">brandNewUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="cm">/* new user info */</span><span class="o">);</span>
<span class="nc">UpdateValue</span> <span class="n">updateOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateValue</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="nc">Location</span><span class="o">)</span>
        <span class="c1">// As before, we set this option to true</span>
        <span class="o">.</span><span class="na">withFetchOption</span><span class="o">(</span><span class="nc">FetchValue</span><span class="o">.</span><span class="na">Option</span><span class="o">.</span><span class="na">DELETED_VCLOCK</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUpdate</span><span class="o">(</span><span class="nc">Update</span><span class="o">.</span><span class="na">clobberUpdate</span><span class="o">(</span><span class="n">brandNewUser</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">updateOp</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="no-operation-updates-in-java">No-operation Updates in Java</h3>

<p>The Java client also enables you to construct <strong>no-operation updates</strong>
that don’t actually modify the object and simply write the original
value back to Riak. What is the use of that, given that it isn’t
changing the value of the object at all? No-operation updates can be
useful because they can help Riak resolve <a href="/riak/kv/2.1.1/developing/usage/conflict-resolution#siblings">sibling conflicts</a>. If you have an object—or many objects, for that
matter—with siblings, a no-operation update will fetch the object <em>and
its causal context</em> and write the object back to Riak with the same,
fetched context. This has the effect of telling Riak that you deem this
value to be most current. Riak can then use this information in internal
sibling resolution operations.</p>

<p>Below is an example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Location</span> <span class="n">loc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Location</span><span class="o">(...);</span>
<span class="nc">UpdateValue</span> <span class="n">updateOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateValue</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">loc</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUpdate</span><span class="o">(</span><span class="nc">Update</span><span class="o">.</span><span class="na">noopUpdate</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">updateOp</span><span class="o">);</span>
</code></pre></div></div>

<p>The example above would update the object without fetching it. You
could, however, use a no-operation update to <em>read</em> an object as well if
you set <code class="language-plaintext highlighter-rouge">return_body</code> to <code class="language-plaintext highlighter-rouge">true</code> in your request:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using the Location object "loc" from above:</span>
<span class="nc">UpdateValue</span> <span class="n">updateOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateValue</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">loc</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withFetchOption</span><span class="o">(</span><span class="nc">Option</span><span class="o">.</span><span class="na">RETURN_BODY</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUpdate</span><span class="o">(</span><span class="nc">Update</span><span class="o">.</span><span class="na">noopUpdate</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="nc">UpdateValue</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">updateOp</span><span class="o">);</span>
<span class="nc">RiakObject</span> <span class="n">object</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="nc">RiakObject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Or to continue the User example from above:</span>
<span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>In general, you should use no-operation updates only on keys that you
suspect may have accumulated siblings or on keys that are frequently
updated (and thus bear the possibility of accumulating siblings).
Otherwise, you’re better off performing normal reads.</p>
