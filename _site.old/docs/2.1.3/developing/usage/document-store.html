<p>Although Riak wasn’t explicitly created as a document store, two
features recently added to Riak—<a href="/riak/kv/2.1.3/developing/usage/search/">Riak Search</a> and <a href="/riak/kv/2.1.3/developing/data-types/">Riak Data Types</a>—make it possible to use Riak as a
highly scalable document store with rich querying capabilities. In this
tutorial, we’ll build a basic implementation of a document store using
<a href="/riak/kv/2.1.3/developing/data-types/maps">Riak maps</a>.</p>

<h2 id="basic-approach">Basic Approach</h2>

<p>Riak Search enables you to implement a document store in Riak in a
variety of ways. You could, for example, store and query JSON objects or
XML and then retrieve them later via Solr queries. In this tutorial,
however, we will store data in <a href="/riak/kv/2.1.3/developing/data-types/maps">Riak maps</a>,
index that data using Riak Search, and then run Solr queries against
those stored objects.</p>

<p>You can think of these Search indexes as <strong>collections</strong>. Each indexed
document will have an ID generated automatically by Search, and because
we’re not interested in running normal <a href="/riak/kv/2.1.3/developing/key-value-modeling">key/value queries</a> on these objects, we’ll allow Riak to assign <a href="/riak/kv/2.1.3/learn/concepts/keys-and-objects">keys</a> automatically. This means that all we have to do is worry about the bucket type and/or bucket when storing objects.</p>

<h2 id="use-case">Use Case</h2>

<p>Let’s say that we’re building a WordPress-style CMS and storing blog
posts in Riak. We will be storing the following information about each
post:</p>

<ul>
  <li>Title</li>
  <li>Author</li>
  <li>Content (the body of the post)</li>
  <li>Keywords associated with the post</li>
  <li>Date posted</li>
  <li>Whether the post has been published on the site</li>
</ul>

<p>For each of those pieces of information, we’ll need to decide on (a)
which Riak Data Type most directly corresponds and (b) which Solr type
we want to associate with the info. It’s important to bear in mind that
Riak Data Types can be indexed as a wide variety of things, e.g.
registers as Solr text fields, sets as multi-valued datetimes, etc. The
table below shows which Riak Data Type and Solr type we’ll be using for
each field in our Riak maps.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Info</th>
      <th style="text-align: left">Riak Data Type</th>
      <th style="text-align: left">Solr type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Post title</td>
      <td style="text-align: left">Register</td>
      <td style="text-align: left">String</td>
    </tr>
    <tr>
      <td style="text-align: left">Post author</td>
      <td style="text-align: left">Register</td>
      <td style="text-align: left">String</td>
    </tr>
    <tr>
      <td style="text-align: left">Post content</td>
      <td style="text-align: left">Register</td>
      <td style="text-align: left">Text</td>
    </tr>
    <tr>
      <td style="text-align: left">Keywords</td>
      <td style="text-align: left">Set</td>
      <td style="text-align: left">Multi-valued string</td>
    </tr>
    <tr>
      <td style="text-align: left">Date posted</td>
      <td style="text-align: left">Register</td>
      <td style="text-align: left">Datetime</td>
    </tr>
    <tr>
      <td style="text-align: left">Whether the post is currently in draft form</td>
      <td style="text-align: left">Flag</td>
      <td style="text-align: left">Boolean</td>
    </tr>
  </tbody>
</table>

<p>Before we start actually creating and storing blog posts, let’s set up
Riak Search with an appropriate index and schema.</p>

<h2 id="creating-a-schema-and-index">Creating a Schema and Index</h2>

<p>In the documentation on <a href="/riak/kv/2.1.3/developing/usage/search-schemas">search schemas</a>, you’ll find a
baseline schema to be used for creating custom schemas. We’ll use that
baseline schema here and add the following fields to the <code class="language-plaintext highlighter-rouge">&lt;fields&gt;</code>
list:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"title_register"</span>   <span class="na">type=</span><span class="s">"string"</span>   <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"author_register"</span>  <span class="na">type=</span><span class="s">"string"</span>   <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"content_register"</span> <span class="na">type=</span><span class="s">"text"</span>     <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"keywords_set"</span>     <span class="na">type=</span><span class="s">"string"</span>   <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="na">multiValued=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"date_register"</span>    <span class="na">type=</span><span class="s">"datetime"</span> <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"published_flag"</span>   <span class="na">type=</span><span class="s">"boolean"</span>  <span class="na">indexed=</span><span class="s">"true"</span> <span class="na">stored=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>You can see the full schema <a href="https://github.com/basho/basho_docs/raw/master/extras/data/blog_post_schema.xml">on
GitHub</a>.
Let’s store that schema in a file called <code class="language-plaintext highlighter-rouge">blog_post_schema.xml</code> and
upload that schema to Riak:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.commons.io.FileUtils</span><span class="o">;</span>

<span class="nc">File</span> <span class="n">xml</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"blog_post_schema.xml"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">xmlString</span> <span class="o">=</span> <span class="nc">FileUtils</span><span class="o">.</span><span class="na">readFileToString</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
<span class="nc">YokozunaSchema</span> <span class="n">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">YokozunaSchema</span><span class="o">(</span><span class="s">"blog_post_schema"</span><span class="o">,</span> <span class="n">xmlString</span><span class="o">);</span>
<span class="nc">StoreSchema</span> <span class="n">storeSchemaOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StoreSchema</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">schema</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">storeSchemaOp</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">schema_data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'blog_post_schema.xml'</span><span class="p">)</span>
<span class="n">client</span><span class="p">.</span><span class="nf">create_search_schema</span><span class="p">(</span><span class="s1">'blog_post_schema'</span><span class="p">,</span> <span class="n">schema_data</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$schema_string</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'blog_post_schema.xml'</span><span class="p">);</span>
<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\StoreSchema</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withName</span><span class="p">(</span><span class="s1">'blog_post_schema'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">withSchemaString</span><span class="p">(</span><span class="nv">$schema_string</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xml_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'blog_post_schema.xml'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="n">schema_data</span> <span class="o">=</span> <span class="n">xml_file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">client</span><span class="p">.</span><span class="n">create_search_schema</span><span class="p">(</span><span class="s">'blog_post_schema'</span><span class="p">,</span> <span class="n">schema_data</span><span class="p">)</span>
<span class="n">xml_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">schemaXml</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllText</span><span class="p">(</span><span class="s">"blog_post_schema.xml"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">schema</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SearchSchema</span><span class="p">(</span><span class="s">"blog_post_schema"</span><span class="p">,</span> <span class="n">schemaXml</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">PutSearchSchema</span><span class="p">(</span><span class="n">schema</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Full example here:
 *  https://github.com/basho/riak-nodejs-client-examples/blob/master/dev/search/document-store.js
 *
 */</span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">schemaName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">blog_post_schema</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">schema</span><span class="p">:</span> <span class="nx">schemaXml</span>
<span class="p">};</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">storeSchema</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">SchemaData</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="s">"blog_post_schema.xml"</span><span class="p">),</span>
<span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nf">create_search_schema</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"blog_post_schema"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">SchemaData</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPUT $RIAK_HOST/search/schema/blog_post_schema \
     -H 'Content-Type: application/xml' \
     --data-binary @blog_post_schema.xml
</code></pre>

<p>With our schema uploaded, we can create an index called <code class="language-plaintext highlighter-rouge">blog_posts</code> and
associate that index with our schema:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">YokozunaIndex</span> <span class="n">blogPostIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">YokozunaIndex</span><span class="o">(</span><span class="s">"blog_posts"</span><span class="o">,</span> <span class="s">"blog_post_schema"</span><span class="o">);</span>
<span class="nc">StoreIndex</span> <span class="n">storeIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StoreIndex</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">blogPostIndex</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">storeIndex</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span><span class="p">.</span><span class="nf">create_search_index</span><span class="p">(</span><span class="s1">'blog_posts'</span><span class="p">,</span> <span class="s1">'blog_post_schema'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">new</span> <span class="nc">Command\Builder\Search\StoreIndex</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withName</span><span class="p">(</span><span class="s1">'blog_posts'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">usingSchema</span><span class="p">(</span><span class="s1">'blog_post_schema'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span><span class="p">.</span><span class="n">create_search_index</span><span class="p">(</span><span class="s">'blog_posts'</span><span class="p">,</span> <span class="s">'blog_post_schema'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">idx</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SearchIndex</span><span class="p">(</span><span class="s">"blog_posts"</span><span class="p">,</span> <span class="s">"blog_post_schema"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">PutSearchIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">schemaName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">blog_post_schema</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">indexName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">blog_posts</span><span class="dl">'</span>
<span class="p">};</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">storeIndex</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">riakc_pb_socket</span><span class="p">:</span><span class="nf">create_search_index</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"blog_posts"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">"blog_post_schema"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[]).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPUT $RIAK_HOST/search/index/blog_posts \
     -H 'Content-Type: application/json' \
     -d '{"schema": "blog_post_schema"}'
</code></pre>

<h2 id="how-collections-will-work">How Collections will Work</h2>

<p>Collections are not a concept that is native to Riak but we can easily
mimic collections by thinking of a bucket type as a collection. When we
associate a bucket type with a Riak Search index, all of the objects
stored in any bucket of that bucket type will be queryable on the basis
of that one index. For this tutorial, we’ll create a bucket type called
<code class="language-plaintext highlighter-rouge">cms</code> and think of that as a collection. We could also restrict our
<code class="language-plaintext highlighter-rouge">blog_posts</code> index to a single bucket just as easily and think of that
as a queryable collection, but we will not do that in this tutorial.</p>

<p>The advantage of the bucket-type-based approach is that we could store
blog posts from different blogs in different buckets and query them
all at once as part of the same index. It depends on the use case at
hand. In this tutorial, we’ll only be storing posts from one blog, which
is called “Cat Pics Quarterly” and provides in-depth theoretical
discussions of cat pics with a certain number of Reddit upvotes. All of
the posts in this blog will be stored in the bucket
<code class="language-plaintext highlighter-rouge">cat_pics_quarterly</code>.</p>

<p>First, let’s create our <code class="language-plaintext highlighter-rouge">cms</code> bucket type and associate it with the
<code class="language-plaintext highlighter-rouge">blog_posts</code> index:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>riak-admin bucket-type create cms <span class="se">\</span>
  <span class="s1">'{"props":{"datatype":"map","search_index":"blog_posts"}}'</span>
riak-admin bucket-type activate cms
</code></pre></div></div>

<p>Now, any object stored in any bucket of the type <code class="language-plaintext highlighter-rouge">cms</code> will be indexed
as part of our “collection.”</p>

<h2 id="storing-blog-posts-as-maps">Storing Blog Posts as Maps</h2>

<p>Now that we know how each element of a blog post can be translated into
one of the Riak Data Types, we can create an interface in our
application to serve as that translation layer. Using the method
described in <a href="/riak/kv/2.1.3/developing/data-modeling">Data Modeling with Riak Data Types</a>, we can construct a
class that looks like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlogPost</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">author</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keywords</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">DateTime</span> <span class="n">datePosted</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Boolean</span> <span class="n">published</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">bucketType</span> <span class="o">=</span> <span class="s">"cms"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Location</span> <span class="n">location</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">RiakClient</span> <span class="n">client</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BlogPost</span><span class="o">(</span><span class="nc">RiakClient</span> <span class="n">client</span>
                    <span class="nc">String</span> <span class="n">bucketName</span><span class="o">,</span>
                    <span class="nc">String</span> <span class="n">title</span><span class="o">,</span>
                    <span class="nc">String</span> <span class="n">author</span><span class="o">,</span>
                    <span class="nc">String</span> <span class="n">content</span><span class="o">,</span>
                    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keywords</span><span class="o">,</span>
                    <span class="nc">DateTime</span> <span class="n">datePosted</span><span class="o">,</span>
                    <span class="nc">Boolean</span> <span class="n">published</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">location</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Location</span><span class="o">(</span><span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="n">bucketType</span><span class="o">,</span> <span class="n">bucketName</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">author</span> <span class="o">=</span> <span class="n">author</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">keywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">datePosted</span> <span class="o">=</span> <span class="n">datePosted</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">published</span> <span class="o">=</span> <span class="n">published</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">store</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">RegisterUpdate</span> <span class="n">titleUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>
        <span class="nc">RegisterUpdate</span> <span class="n">authorUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="n">author</span><span class="o">);</span>
        <span class="nc">RegisterUpdate</span> <span class="n">contentUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
        <span class="nc">SetUpdate</span> <span class="n">keywordsUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SetUpdate</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">keyword</span> <span class="o">:</span> <span class="n">keywords</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">keywordsUpdate</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">keyword</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">RegisterUpdate</span> <span class="n">dateUpdate</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nf">RegisterUpdate</span><span class="o">(</span><span class="n">datePosted</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="s">"YYYY-MM-DD HH:MM"</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">published</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">FlagUpdate</span> <span class="n">published</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">(</span><span class="n">published</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">FlagUpdate</span> <span class="n">publishedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">(</span><span class="n">published</span><span class="o">);</span>
        <span class="nc">MapUpdate</span> <span class="n">mapUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
            <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">titleUpdate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span> <span class="n">authorUpdate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"content"</span><span class="o">,</span> <span class="n">contentUpdate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"keywords"</span><span class="o">,</span> <span class="n">keywordsUpdate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"date"</span><span class="o">,</span> <span class="n">dateUpdate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"published"</span><span class="o">,</span> <span class="n">publishedUpdate</span><span class="o">);</span>
        <span class="nc">UpdateMap</span> <span class="n">storeBlogPost</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">mapUpdate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">storeBlogPost</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BlogPost</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">date_posted</span><span class="p">,</span> <span class="n">published</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span><span class="p">(</span><span class="s1">'cms'</span><span class="p">).</span><span class="nf">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
    <span class="n">map</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">Crdt</span><span class="o">::</span><span class="no">Map</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">map</span><span class="p">.</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
      <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
      <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'author'</span><span class="p">]</span> <span class="o">=</span> <span class="n">author</span>
      <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
      <span class="n">keywords</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
        <span class="n">m</span><span class="p">.</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'keywords'</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_posted</span>
      <span class="k">if</span> <span class="n">published</span>
        <span class="n">m</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'published'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">BlogPost</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nv">$title</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">private</span> <span class="nv">$author</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">private</span> <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">private</span> <span class="nv">$keywords</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">private</span> <span class="nv">$datePosted</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">private</span> <span class="nv">$published</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">private</span> <span class="nv">$bucketType</span> <span class="o">=</span> <span class="s2">"cms"</span><span class="p">;</span>

  <span class="k">private</span> <span class="nv">$bucket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">private</span> <span class="nv">$riak</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="err">\</span><span class="nc">Basho\Riak</span> <span class="nv">$riak</span><span class="p">,</span> <span class="nv">$bucket</span><span class="p">,</span> <span class="nv">$title</span><span class="p">,</span> <span class="nv">$author</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$keywords</span><span class="p">,</span> <span class="nv">$date</span><span class="p">,</span> <span class="nv">$published</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">riak</span> <span class="o">=</span> <span class="nv">$riak</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bucket</span><span class="p">(</span><span class="nv">$bucket</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">bucketType</span><span class="p">);</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">title</span> <span class="o">=</span> <span class="nv">$title</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">author</span> <span class="o">=</span> <span class="nv">$author</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">keywords</span> <span class="o">=</span> <span class="nv">$keywords</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">datePosted</span> <span class="o">=</span> <span class="nv">$date</span><span class="p">;</span>
    <span class="n">this</span><span class="o">-&gt;</span><span class="n">published</span> <span class="o">=</span> <span class="nv">$published</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">store</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$setBuilder</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateSet</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">riak</span><span class="p">));</span>
      
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">keywords</span> <span class="k">as</span> <span class="nv">$keyword</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$setBuilder</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$keyword</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">riak</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">title</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'author'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">author</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'content'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">updateFlag</span><span class="p">(</span><span class="s1">'published'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">published</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">updateSet</span><span class="p">(</span><span class="s1">'keywords'</span><span class="p">,</span> <span class="nv">$setBuilder</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">withBucket</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
      <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">riak.datatypes</span> <span class="kn">import</span> <span class="n">Map</span>

<span class="k">class</span> <span class="nc">BlogPost</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">date_posted</span><span class="p">,</span> <span class="n">published</span><span class="p">):</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s">'cms'</span><span class="p">).</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'title'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'author'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'content'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">sets</span><span class="p">[</span><span class="s">'keywords'</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_posted</span>
        <span class="k">if</span> <span class="n">published</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="s">'published'</span><span class="p">].</span><span class="n">enable</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Please see the code in the RiakClientExamples project:
 * https://github.com/basho/riak-dotnet-client/tree/develop/src/RiakClientExamples/Dev/Search
 */</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Please see the code in the examples repository:
 * https://github.com/basho/riak-nodejs-client-examples/blob/master/dev/search/
 */</span>
</code></pre></div></div>

<p>Now, we can store some blog posts. We’ll start with just one:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keywords</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
<span class="n">keywords</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"adorbs"</span><span class="o">);</span>
<span class="n">keywords</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"cheshire"</span><span class="o">);</span>

<span class="nc">BlogPost</span> <span class="n">post1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlogPost</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="c1">// client object</span>
                              <span class="s">"cat_pics_quarterly"</span><span class="o">,</span> <span class="c1">// bucket</span>
                              <span class="s">"This one is so lulz!"</span><span class="o">,</span> <span class="c1">// title</span>
                              <span class="s">"Cat Stevens"</span><span class="o">,</span> <span class="c1">// author</span>
                              <span class="s">"Please check out these cat pics!"</span><span class="o">,</span> <span class="c1">// content</span>
                              <span class="n">keywords</span><span class="o">,</span> <span class="c1">// keywords</span>
                              <span class="k">new</span> <span class="nf">DateTime</span><span class="o">(),</span> <span class="c1">// date posted</span>
                              <span class="kc">true</span><span class="o">);</span> <span class="c1">// published</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">post1</span><span class="o">.</span><span class="na">store</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'adorbs'</span><span class="p">,</span> <span class="s1">'cheshire'</span><span class="p">]</span>
<span class="n">date</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-%d %H:%M'</span><span class="p">)</span>
<span class="n">blog_post1</span> <span class="o">=</span> <span class="no">BlogPost</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'cat_pics_quarterly'</span><span class="p">,</span>
                          <span class="s1">'This one is so lulz!'</span><span class="p">,</span>
                          <span class="s1">'Cat Stevens'</span><span class="p">,</span>
                          <span class="s1">'Please check out these cat pics!'</span><span class="p">,</span>
                          <span class="n">keywords</span><span class="p">,</span>
                          <span class="n">date</span><span class="p">,</span>
                          <span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'adorbs'</span><span class="p">,</span> <span class="s1">'cheshire'</span><span class="p">];</span>
<span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DateTime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>

<span class="nv">$post1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlogPost</span><span class="p">(</span>
  <span class="nv">$riak</span><span class="p">,</span> <span class="c1">// client object</span>
  <span class="s1">'cat_pics_quarterly'</span><span class="p">,</span> <span class="c1">// bucket</span>
  <span class="s1">'This one is so lulz!'</span><span class="p">,</span> <span class="c1">// title</span>
  <span class="s1">'Cat Stevens'</span><span class="p">,</span> <span class="c1">// author</span>
  <span class="s1">'Please check out these cat pics!'</span><span class="p">,</span> <span class="c1">// content</span>
  <span class="nv">$keywords</span><span class="p">,</span> <span class="c1">// keywords</span>
  <span class="nv">$date</span><span class="p">,</span> <span class="c1">// date posted</span>
  <span class="kc">true</span> <span class="c1">// published</span>
<span class="p">);</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">'adorbs'</span><span class="p">,</span> <span class="s">'cheshire'</span><span class="p">]</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d %H:%M'</span><span class="p">)</span>
<span class="n">blog_post1</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">(</span><span class="s">'cat_pics_quarterly'</span><span class="p">,</span>
                      <span class="s">'This one is so lulz!'</span><span class="p">,</span>
                      <span class="s">'Cat Stevens'</span><span class="p">,</span>
                      <span class="s">'Please check out these cat pics!'</span><span class="p">,</span>
                      <span class="n">keywords</span><span class="p">,</span>
                      <span class="n">date</span><span class="p">,</span>
                      <span class="n">true</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">keywords</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="s">"adorbs"</span><span class="p">,</span> <span class="s">"cheshire"</span> <span class="p">};</span>

<span class="kt">var</span> <span class="n">post</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlogPost</span><span class="p">(</span>
    <span class="s">"This one is so lulz!"</span><span class="p">,</span>
    <span class="s">"Cat Stevens"</span><span class="p">,</span>
    <span class="s">"Please check out these cat pics!"</span><span class="p">,</span>
    <span class="n">keywords</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">,</span>
    <span class="k">true</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">repo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlogPostRepository</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">"cat_pics_quarterly"</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">id</span> <span class="p">=</span> <span class="n">repo</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="n">post</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlogPost</span><span class="p">(</span>
    <span class="dl">'</span><span class="s1">This one is so lulz!</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Cat Stevens</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Please check out these cat pics!</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">[</span> <span class="dl">'</span><span class="s1">adorbs</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">cheshire</span><span class="dl">'</span> <span class="p">],</span>
    <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
    <span class="kc">true</span>
<span class="p">);</span>

<span class="kd">var</span> <span class="nx">repo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlogPostRepository</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="dl">'</span><span class="s1">cat_pics_quarterly</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">repo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">key: '%s', model: '%s'</span><span class="dl">"</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rslt</span><span class="p">.</span><span class="nx">model</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="querying">Querying</h2>

<p>Now that we have some blog posts stored in our “collection,” we can
start querying for whatever we’d like. Let’s say that we want to find
all blog posts with the keyword <code class="language-plaintext highlighter-rouge">funny</code> (after all, some cat pics are
quite serious, and we may not want those).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">index</span> <span class="o">=</span> <span class="s">"blog_posts"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"keywords_set:funny"</span><span class="o">;</span>

<span class="nc">SearchOperation</span> <span class="n">searchOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchOperation</span>
    <span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="nc">BinaryValue</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">index</span><span class="o">),</span> <span class="n">query</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">cluster</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">searchOp</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">searchOp</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getAllResults</span><span class="o">();</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'blog_posts'</span><span class="p">,</span> <span class="s1">'keywords_set:funny'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\Search\FetchObjects</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withIndexName</span><span class="p">(</span><span class="s1">'blog_posts'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">(</span><span class="s1">'keywords_set:funny'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">fulltext_search</span><span class="p">(</span><span class="s">'blog_posts'</span><span class="p">,</span> <span class="s">'keywords_set:funny'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">searchRequest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakSearchRequest</span><span class="p">(</span><span class="s">"blog_posts"</span><span class="p">,</span> <span class="s">"keywords_set:funny"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="n">searchRequest</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">searchCmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">YZ</span><span class="p">.</span><span class="nx">Search</span><span class="p">.</span><span class="nx">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">withIndexName</span><span class="p">(</span><span class="dl">'</span><span class="s1">blog_posts</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">withQuery</span><span class="p">(</span><span class="dl">'</span><span class="s1">keywords_set:funny</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">withCallback</span><span class="p">(</span><span class="nx">search_cb</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">searchCmd</span><span class="p">);</span>
</code></pre></div></div>

<pre><code class="language-curl">curl "$RIAK_HOST/search/query/blog_posts?wt=json&amp;q=keywords_set:funny"
</code></pre>

<p>Or we can find posts that contain the word <code class="language-plaintext highlighter-rouge">furry</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">index</span> <span class="o">=</span> <span class="s">"blog_posts"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"content_register:furry"</span><span class="o">;</span>

<span class="nc">SearchOperation</span> <span class="n">searchOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchOperation</span>
    <span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="nc">BinaryValue</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">index</span><span class="o">),</span> <span class="n">query</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">cluster</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">searchOp</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">searchOp</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getAllResults</span><span class="o">();</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'blog_posts'</span><span class="p">,</span> <span class="s1">'content_register:furry'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\Search\FetchObjects</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
  <span class="o">-&gt;</span><span class="nf">withIndexName</span><span class="p">(</span><span class="s1">'blog_posts'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">(</span><span class="s1">'content_register:furry'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">fulltext_search</span><span class="p">(</span><span class="s">'blog_posts'</span><span class="p">,</span> <span class="s">'content_register:furry'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">searchRequest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RiakSearchRequest</span><span class="p">(</span><span class="s">"blog_posts"</span><span class="p">,</span> <span class="s">"content_register:furry"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="n">searchRequest</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">searchCmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">YZ</span><span class="p">.</span><span class="nx">Search</span><span class="p">.</span><span class="nx">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">withIndexName</span><span class="p">(</span><span class="dl">'</span><span class="s1">blog_posts</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">withQuery</span><span class="p">(</span><span class="dl">'</span><span class="s1">content_register:furry</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">withCallback</span><span class="p">(</span><span class="nx">search_cb</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">searchCmd</span><span class="p">);</span>
</code></pre></div></div>

<pre><code class="language-curl">curl "$RIAK_HOST/search/query/blog_posts?wt=json&amp;q=content_register:furry"
</code></pre>

<p>Here are some more possible queries:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Info</th>
      <th style="text-align: left">Query</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Unpublished posts</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">published_flag:false</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Titles that begin with <code class="language-plaintext highlighter-rouge">Loving*</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">title_register:Loving*</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Post bodies containing the words <code class="language-plaintext highlighter-rouge">furry</code> and <code class="language-plaintext highlighter-rouge">jumping</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">content_register:[furry AND jumping]</code></td>
    </tr>
  </tbody>
</table>
