
<p>Virtual nodes, more commonly referred to as <strong>vnodes</strong>, are processes
that manage partitions in the Riak <a href="/riak/kv/2.1.4/learn/glossary/#ring">ring</a>. Each data
partition in a Riak cluster has a vnode that <strong>claims</strong> that partition.
Vnodes perform a wide variety of operations, from K/V storage operations
to guaranteeing <a href="/riak/kv/2.1.4/learn/concepts/strong-consistency">strong consistency</a> if you choose to use that
feature.</p>

<h2 id="the-number-of-vnodes-in-a-cluster">The Number of Vnodes in a Cluster</h2>

<p>The term <a href="/riak/kv/2.1.4/learn/glossary/#node">node</a> refers to a full instance of Riak,
be it on its own physical machine or alongside others on a single
machine, as in a development cluster on your laptop. Each Riak node
contains multiple vnodes. The number per node is the <a href="/riak/kv/2.1.4/learn/concepts/clusters/#the-ring">ring
size</a> divided by the number of nodes in the cluster.</p>

<p>This means that in some clusters different nodes will have different
numbers of data partitions (and hence a different number of vnodes),
because (ring size / number of nodes) will not produce an even integer.
If the ring size of your cluster is 64 and you are running three nodes,
two of your nodes will have 21 vnodes, while the third node holds 22
vnodes.</p>

<p>The output of the <a href="/riak/kv/2.1.4/using/admin/riak-cli"><code class="language-plaintext highlighter-rouge">riak-admin member-status</code></a>
command shows this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>================================= Membership ==================================
Status     Ring    Pending    Node
-------------------------------------------------------------------------------
valid      34.4%      --      'dev1@127.0.0.1'
valid      32.8%      --      'dev2@127.0.0.1'
valid      32.8%      --      'dev3@127.0.0.1'
-------------------------------------------------------------------------------
Valid: 3 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
</code></pre></div></div>

<p>In this cluster, one node accounts for 34.4% of the ring, i.e. 22 out of
64 partitions, while the other two nodes account for 32.8%, i.e. 21 out
of 64 partitions. This is normal and expected behavior in Riak.</p>

<p>We strongly recommend setting the appropriate ring size, and by
extension the number of vnodes, prior to building a cluster. A full
guide can be found in our <a href="/riak/kv/2.1.4/setup/planning/cluster-capacity">cluster planning</a> documentation.</p>

<h2 id="the-role-of-vnodes">The Role of Vnodes</h2>

<p>Vnodes essentially watch over a designated subset of a cluster’s key
space. Riak computes a 160-bit binary hash of each bucket/key pair and
maps this value to a position on an ordered <a href="/riak/kv/2.1.4/learn/concepts/clusters/#the-ring">ring</a>
of all such values. The illustration below provides a visual
representation of the Riak ring:</p>

<p><img src="http://docs.basho.com/shared/2.0.2/images/riak-ring.png?1416296175" alt="The Riak
Ring" /></p>

<p>You can think of vnodes as managers, responsible for handling incoming
requests from other nodes/vnodes, storing objects in the appropriate
storage backend, fetching objects from backends, interpreting <a href="/riak/kv/2.1.4/learn/concepts/causal-context">causal
context</a> metadata for objects, acting as <a href="/riak/kv/2.1.4/learn/concepts/strong-consistency">strong consistency
ensembles</a> and much
more.  At the system level, vnodes are Erlang processes build on top of
the <a href="http://www.erlang.org/doc/design_principles/fsm.html"><code class="language-plaintext highlighter-rouge">gen_fsm</code></a>
abstraction in Erlang, i.e. you can think of vnodes as <strong>finite state
machines</strong> that are constantly at work ensuring that Riak’s key
goals—high availability, fault tolerance, etc.—are guaranteed for
their allotted portion of the cluster’s key space. Whereas nodes are
essentially a passive container for a wide variety of Riak processes,
vnodes are the true workhorses of Riak.</p>

<p>While each vnode has a main Erlang process undergirding it, vnodes may
also spawn new worker processes (i.e. new Erlang actors) to perform
asynchronous tasks on behalf of the vnode.</p>

<p>If you’re navigating through the file system of a Riak node, you’ll
notice that each node’s <code class="language-plaintext highlighter-rouge">/data</code> directory holds a variety of
subdirectories. If you’re using, say, <a href="/riak/kv/2.1.4/setup/planning/backend/bitcask">Bitcask</a> as a backend, navigate
into the <code class="language-plaintext highlighter-rouge">/bitcask</code> directory (you’ll also see a <code class="language-plaintext highlighter-rouge">/ring</code> directory and
several others). If you open up the <code class="language-plaintext highlighter-rouge">/bitcask</code> directory, you’ll see a
wide assortment of directories with numbers as names, e.g. <code class="language-plaintext highlighter-rouge">0</code> or
<code class="language-plaintext highlighter-rouge">1004782375664995756265033322492444576013453623296</code>. These directories
each house the data from a particular partition.</p>

<h2 id="vnodes-and-replication-properties">Vnodes and Replication Properties</h2>

<p>In our documentation on <a href="/riak/kv/2.1.4/learn/concepts/replication">replication properties</a>, we make frequent
mention of users’ ability to choose how many nodes store copies of
data, how many nodes must respond for a read request to succeed, and so
on. This is slightly misleading, as the fundamental units of replication
are not nodes but rather vnodes.</p>

<p>This can be illustrated by way of a potential user error.  If you store
an object and set N=5, this means that you want the object to be stored
on 5 different nodes. But imagine that your cluster only has 3 nodes.
Setting N=5 on a 3-node cluster is actually just fine. The data will be
managed by 5 vnodes, but some of that data may end up being stored more
than once on different nodes. A likely scenario is that two nodes will
store two copies of the data a piece, while the third node will store
only one. Absent such an error, however, nodes will not contain multiple
vnodes responsible for the same partition.</p>

<h2 id="vnode-status">Vnode Status</h2>

<p>You can check the current status of all vnodes in your cluster using the
<a href="/riak/kv/2.1.4/using/admin/riak-cli"><code class="language-plaintext highlighter-rouge">riak-admin vnode-status</code></a> command.</p>

<p>The <code class="language-plaintext highlighter-rouge">riak-admin vnode-status</code> command should not be used more frequently than every 5 minutes. Running it more often will result in handoffs being stalled.</p>

<p>The output of <code class="language-plaintext highlighter-rouge">riak-admin vnode-status</code> is a series of reports on each active vnode running on the local node. A report for a specific vnode should look like the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VNode: 1278813932664540053428224228626747642198940975104
Backend: riak_kv_bitcask_backend
Status:
[{key_count, 275},
 {status,[{"./data/bitcask/1278813932664540053428224228626747642198940975104/2.bitcask.data",
           0,0,335}]}]
Status:
{vnodeid,&lt;&lt;"ÅR±\vi80\f"&gt;&gt;}
</code></pre></div></div>

<p>The meaning of each field is given in the table below.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Field</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">VNode</code></td>
      <td style="text-align: left">The ID of the vnode in question</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Backend</code></td>
      <td style="text-align: left">The storage <a href="/riak/kv/2.1.4/setup/planning/backend">backend</a> utilized by the vnode</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Status</code></td>
      <td style="text-align: left">The number of keys managed by the vnode and the file where the vnode stores its data. The other information can be ignored.</td>
    </tr>
  </tbody>
</table>
