<p>Maps are the most versatile of the Riak data types because all other data types can be embedded within them, <em>including maps themselves</em>. This enables the creation of complex, custom data types from a few basic building blocks.</p>

<p>Using counters, sets, and maps within maps are similar to working with those types at the bucket level.</p>

<h2 id="set-up-a-bucket-type">Set Up a Bucket Type</h2>

<blockquote>
  <p>If you’ve already created and activated a bucket type with the <code class="language-plaintext highlighter-rouge">datatype</code> parameter set to <code class="language-plaintext highlighter-rouge">map</code>, skip to the <a href="#client-setup">next section</a>.</p>
</blockquote>

<p>Start by creating a bucket type with the <code class="language-plaintext highlighter-rouge">datatype</code> parameter set to <code class="language-plaintext highlighter-rouge">map</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>riak-admin bucket-type create maps <span class="s1">'{"props":{"datatype":"map"}}'</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong></p>

  <p>The <code class="language-plaintext highlighter-rouge">maps</code> bucket type name provided above is an example and is not required to be <code class="language-plaintext highlighter-rouge">maps</code>. You are free to name bucket types whatever you like, with the exception of <code class="language-plaintext highlighter-rouge">default</code>.</p>
</blockquote>

<p>After creating a bucket with a Riak data type, confirm the bucket property configuration associated with that type is correct:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>riak-admin bucket-type status maps
</code></pre></div></div>

<p>This returns a list of bucket properties and their values
in the form of <code class="language-plaintext highlighter-rouge">property: value</code>.</p>

<p>If our <code class="language-plaintext highlighter-rouge">map</code> bucket type has been set properly we should see the following pair in our console output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>datatype: map
</code></pre></div></div>

<p>Once we have confirmed the bucket type is properly configured, we can activate the bucket type to be used in Riak KV:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>riak-admin bucket-type activate maps
</code></pre></div></div>

<p>We can check if activation has been successful by using the same <code class="language-plaintext highlighter-rouge">bucket-type status</code> command shown above:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>riak-admin bucket-type status maps
</code></pre></div></div>

<p>After creating and activating our new <code class="language-plaintext highlighter-rouge">maps</code> bucket type, we can setup our client to start using the bucket type as detailed in the next section.</p>

<h2 id="client-setup">Client Setup</h2>

<p>First, we need to direct our client to the bucket type/bucket/key location that contains our map.</p>

<p>The syntax for creating a map is analogous to the
syntax for creating other data types:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// In the Java client, a bucket/bucket type combination is specified</span>
<span class="c1">// using a Namespace object. To specify bucket, bucket type, and key,</span>
<span class="c1">// use a Location object that incorporates the Namespace object, as is</span>
<span class="c1">// done below.</span>

<span class="nc">Location</span> <span class="n">map</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nf">Location</span><span class="o">(</span><span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">"&lt;bucket_type&gt;"</span><span class="o">,</span> <span class="s">"&lt;bucket&gt;"</span><span class="o">),</span> <span class="s">"&lt;key&gt;"</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span><span class="p">(</span><span class="s1">'bucket_type_name'</span><span class="p">).</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'bucket_name'</span><span class="p">)</span>
<span class="n">map</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">Crdt</span><span class="o">::</span><span class="no">Map</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Location</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span> <span class="s1">'bucket'</span><span class="p">,</span> <span class="s1">'bucket_type'</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The client detects the bucket type's datatype and automatically
# returns the right datatype for you, in this case a Map.
</span><span class="nb">map</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># This way is also acceptable:
</span><span class="kn">from</span> <span class="nn">riak.datatypes</span> <span class="kn">import</span> <span class="n">Map</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">WithBucketType</span><span class="p">(</span><span class="s">"&lt;bucket_type&gt;"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithBucket</span><span class="p">(</span><span class="s">"&lt;bucket&gt;"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithKey</span><span class="p">(</span><span class="s">"&lt;key&gt;"</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Options to pass to the various map methods</span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;bucket_type&gt;</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;bucket&gt;</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;key&gt;</span><span class="dl">'</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">%% Maps in the Erlang client are opaque data structures that
%% collect operations as you mutate them. We will associate the data
%% structure with a bucket type, bucket, and key later on.
</span></code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/&lt;bucket_type&gt;/buckets/&lt;bucket&gt;/datatypes/&lt;key&gt;

# Note that this differs from the URL structure for non-data type requests,
# which end in /keys/&lt;key&gt;
</code></pre>

<h2 id="create-a-map">Create a Map</h2>

<p>For this example, say we want to use Riak KV to store information about our company’s customers. We’ll use the <code class="language-plaintext highlighter-rouge">maps</code> bucket type created and activated previously and a bucket called <code class="language-plaintext highlighter-rouge">customers</code>. Each customer’s data will be contained in its own key in the <code class="language-plaintext highlighter-rouge">customers</code> bucket.</p>

<p>We can create a map for the user Ahmed (<code class="language-plaintext highlighter-rouge">ahmed_info</code>) using the <code class="language-plaintext highlighter-rouge">maps</code> bucket type:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// In the Java client, you specify the location of data types</span>
<span class="c1">// before you perform operations on them:</span>

<span class="nc">Location</span> <span class="n">ahmedMap</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nf">Location</span><span class="o">(</span><span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">"maps"</span><span class="o">,</span> <span class="s">"customers"</span><span class="o">),</span> <span class="s">"ahmed_info"</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">customers</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span><span class="p">(</span><span class="s1">'maps'</span><span class="p">).</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'customers'</span><span class="p">)</span>
<span class="n">map</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">Crdt</span><span class="o">::</span><span class="no">Map</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="s1">'ahmed_info'</span><span class="p">)</span>

<span class="c1"># Alternatively, the Ruby client enables you to set a bucket type as being</span>
<span class="c1"># globally associated with a Riak data type. The following would set all</span>
<span class="c1"># map buckets to use the maps bucket type:</span>

<span class="no">Riak</span><span class="o">::</span><span class="no">Crdt</span><span class="o">::</span><span class="no">DEFAULT_BUCKET_TYPES</span><span class="p">[</span><span class="ss">:map</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'maps'</span>

<span class="c1"># This would enable us to create our map without specifying a bucket type:</span>

<span class="n">customers</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'customers'</span><span class="p">)</span>
<span class="n">map</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">Crdt</span><span class="o">::</span><span class="no">Map</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="s1">'ahmed_info'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Location</span><span class="p">(</span><span class="s1">'ahmed_info'</span><span class="p">,</span> <span class="s1">'customers'</span><span class="p">,</span> <span class="s1">'maps'</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">customers</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s">'map_bucket'</span><span class="p">).</span><span class="n">bucket</span><span class="p">(</span><span class="s">'customers'</span><span class="p">)</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">customers</span><span class="p">.</span><span class="n">net</span><span class="p">(</span><span class="s">'ahmed_info'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">WithBucketType</span><span class="p">(</span><span class="s">"maps"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithBucket</span><span class="p">(</span><span class="s">"customers"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithKey</span><span class="p">(</span><span class="s">"ahmed_info"</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">new</span><span class="p">().</span>

<span class="c">%% Maps in the Erlang client are opaque data structures that
%% collect operations as you mutate them. We will associate the data
%% structure with a bucket type, bucket, and key later on.
</span></code></pre></div></div>

<pre><code class="language-curl"># You cannot create an empty map through the HTTP interface. Maps can only
# be created when a field is added to them, as in the examples below.
</code></pre>

<h2 id="registers">Registers</h2>

<p>Registers are essentially named binaries (like strings). Any binary
value can act as the value of a register. Like flags, registers cannot
be used on their own and must be embedded in Riak maps.</p>

<h3 id="registers-within-maps">Registers Within Maps</h3>

<p>Continuing with our previous <code class="language-plaintext highlighter-rouge">customers</code> example, let’s store some information in our map.</p>

<p>The first piece of information we want to store in our map is Ahmed’s name and
phone number, both of which are best stored as registers:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">RegisterUpdate</span> <span class="n">ru1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="s">"Ahmed"</span><span class="o">);</span>
<span class="nc">RegisterUpdate</span> <span class="n">ru2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="s">"5551234567"</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">mu</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"first_name"</span><span class="o">,</span> <span class="n">ru1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"phone_number"</span><span class="o">,</span> <span class="n">ru2</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">mu</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The Ruby client enables you to batch operations together if you're</span>
<span class="c1"># performing them on one data type.</span>

<span class="n">map</span><span class="p">.</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'first_name'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Ahmed'</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'phone_number'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'5551234567'</span>
<span class="k">end</span>

<span class="c1"># Integers need to be stored as strings and then converted back when</span>
<span class="c1"># the data is retrieved. The following would work as well:</span>
<span class="n">map</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'phone_number'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5551234567</span><span class="p">.</span><span class="nf">to_s</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">,</span> <span class="s1">'Ahmed'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'phone_number'</span><span class="p">,</span> <span class="s1">'5551234567'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'first_name'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="s">'Ahmed'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'phone_number'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="s">'5551234567'</span><span class="p">)</span>

<span class="c1"># Integers need to be stored as strings and then converted back when the
# data is retrieved. The following would work as well:
</span><span class="nb">map</span><span class="p">.</span><span class="n">registers</span><span class="p">[</span><span class="s">'phone_number'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">5551234567</span><span class="p">))</span>

<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">WithBucketType</span><span class="p">(</span><span class="s">"maps"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithBucket</span><span class="p">(</span><span class="s">"customers"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithKey</span><span class="p">(</span><span class="s">"ahmed_info"</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>

<span class="c1">// Ahmed's first name</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">SetRegister</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">,</span> <span class="s">"Ahmed"</span><span class="p">);</span>

<span class="c1">// Ahmed's phone number</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">SetRegister</span><span class="p">(</span><span class="s">"phone_number"</span><span class="p">,</span> <span class="s">"5551234567"</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>

<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">RiakResult</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="n">MapResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
<span class="nf">PrintMap</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
<span class="c1">// Output as JSON:</span>
<span class="c1">// Map: {"Counters":{},"Sets":{},"Registers":{"first_name":"Ahmed","phone_number":"5551234567"},"Flags":{},"Maps":{}}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">setRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">first_name</span><span class="dl">'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="dl">'</span><span class="s1">Ahmed</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">setRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">phone_number</span><span class="dl">'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="dl">'</span><span class="s1">5551234567</span><span class="dl">'</span><span class="p">));</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map1</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"first_name"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">register</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_register</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"Ahmed"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">R</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map</span><span class="p">),</span>
<span class="nv">Map2</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"phone_number"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">register</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_register</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"5551234567"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">R</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map1</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl"># Updates can be performed all at once. The following will create two new
# registers in the map and also set the value of those registers to the
# desired values

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "first_name_register": "Ahmed",
      "phone_number_register": "5551234567"
    }
  }'
</code></pre>

<p>If a register did not previously exist, Riak KV will create that register for you.</p>

<h2 id="flags">Flags</h2>

<p>Flags behave much like Boolean values, except that instead of <code class="language-plaintext highlighter-rouge">true</code> or
<code class="language-plaintext highlighter-rouge">false</code> flags have the values <code class="language-plaintext highlighter-rouge">enable</code> or <code class="language-plaintext highlighter-rouge">disable</code>.</p>

<p>Flags cannot be used on their own, i.e. a flag cannot be stored in a bucket/key by itself. Instead, flags can only be stored within maps.</p>

<p>To disable an existing flag, you have to read it or provide <a href="../#data-types-and-context">a context</a>.</p>

<h3 id="flags-within-maps">Flags Within Maps</h3>

<p>Now let’s say that we add an Enterprise plan to our pricing model. We’ll
create an <code class="language-plaintext highlighter-rouge">enterprise_customer</code> flag to track whether Ahmed has signed
up for the new plan. He hasn’t yet, so we’ll set it to <code class="language-plaintext highlighter-rouge">false</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">MapUpdate</span> <span class="n">mu</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"enterprise_customer"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">mu</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'enterprise_customer'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateFlag</span><span class="p">(</span><span class="s1">'enterprise_customer'</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="s">'enterprise_customer'</span><span class="p">].</span><span class="n">disable</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="c1">// Using our builder from above:</span>

<span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">SetFlag</span><span class="p">(</span><span class="s">"enterprise_customer"</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>
<span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="n">response</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>

<span class="c1">// response.Value as JSON:</span>
<span class="c1">// Map: {"Counters":{},"Sets":{},</span>
         <span class="s">"Registers"</span><span class="p">:{</span><span class="s">"first_name"</span><span class="p">:</span><span class="s">"Ahmed"</span><span class="p">,</span><span class="s">"phone_number"</span><span class="p">:</span><span class="s">"5551234567"</span><span class="p">},</span>
         <span class="s">"Flags"</span><span class="p">:{</span><span class="s">"enterprise_customer"</span><span class="p">:</span><span class="k">false</span><span class="p">},</span><span class="s">"Maps"</span><span class="p">:{}}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">setFlag</span><span class="p">(</span><span class="dl">'</span><span class="s1">enterprise_customer</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map4</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"enterprise_customer"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">flag</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_flag</span><span class="p">:</span><span class="nf">disable</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map3</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info

# Response
{"type":"map","value":{"first_name_register":"Ahmed","phone_number_register":"5551234567"},"context":"g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEBag=="}

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "enterprise_customer_flag": "disable"
    },
    "context" : "g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEBag=="
  }'
</code></pre>

<p>We can retrieve the value of that flag at any time:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">FetchMap</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchMap</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="nc">RiakMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getDatatype</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">getFlag</span><span class="o">(</span><span class="s">"enterprise_customer"</span><span class="o">).</span><span class="na">view</span><span class="o">());</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'enterprise_customer'</span><span class="p">]</span>

<span class="c1"># false</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$map</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\FetchMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">();</span>

<span class="k">echo</span> <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getFlag</span><span class="p">(</span><span class="s1">'enterprise_customer'</span><span class="p">);</span> <span class="c1">// false</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="nb">reload</span><span class="p">().</span><span class="n">flags</span><span class="p">[</span><span class="s">'enterprise_customer'</span><span class="p">].</span><span class="n">value</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="n">Map</span> <span class="n">ahmedMap</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Flags</span><span class="p">[</span><span class="s">"enterprise_customer"</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">fetched map: %s</span><span class="dl">"</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rslt</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">%% The value fetched from Riak is always immutable, whereas the "dirty
%% value" takes into account local modifications that have not been
%% sent to the server.
</span>
<span class="nn">riakc_map</span><span class="p">:</span><span class="nf">dirty_value</span><span class="p">(</span><span class="nv">Map4</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info
</code></pre>

<h2 id="counters-within-maps">Counters Within Maps</h2>

<p>We also want to know how many times Ahmed has visited our website. We’ll
use a <code class="language-plaintext highlighter-rouge">page_visits</code> counter for that and run the following operation
when Ahmed visits our page for the first time:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">MapUpdate</span> <span class="n">mu</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"page_visits"</span><span class="o">,</span> <span class="n">cu</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="k">new</span> <span class="nc">CounterUpdate</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">counters</span><span class="p">[</span><span class="s1">'page_visits'</span><span class="p">].</span><span class="nf">increment</span>

<span class="c1"># This operation may return false even if successful</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateCounter</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\IncrementCounter</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">withIncrement</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateCounter</span><span class="p">(</span><span class="s1">'page_visits'</span><span class="p">,</span> <span class="nv">$updateCounter</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">counters</span><span class="p">[</span><span class="s">'page_visits'</span><span class="p">].</span><span class="n">increment</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">IncrementCounter</span><span class="p">(</span><span class="s">"page_visits"</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>
<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">RiakResult</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="n">MapResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
<span class="c1">// Map: {"Counters":{"page_visits":3},</span>
         <span class="s">"Sets"</span><span class="p">:{},</span>
         <span class="s">"Registers"</span><span class="p">:{</span><span class="s">"first_name"</span><span class="p">:</span><span class="s">"Ahmed"</span><span class="p">,</span><span class="s">"phone_number"</span><span class="p">:</span><span class="s">"5551234567"</span><span class="p">},</span>
         <span class="s">"Flags"</span><span class="p">:{</span><span class="s">"enterprise_customer"</span><span class="p">:</span><span class="k">false</span><span class="p">},</span>
         <span class="s">"Maps"</span><span class="p">:{}}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">incrementCounter</span><span class="p">(</span><span class="dl">'</span><span class="s1">page_visits</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map3</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"page_visits"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">counter</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_counter</span><span class="p">:</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map2</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl"># The following will create a new counter and increment it by 1

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "page_visits_counter": 1
    }
  }'
</code></pre>

<p>Even though the <code class="language-plaintext highlighter-rouge">page_visits</code> counter did not exist previously, the
above operation will create it (with a default starting point of 0) and
the increment operation will bump the counter up to 1.</p>

<h2 id="sets-within-maps">Sets Within Maps</h2>

<p>We’d also like to know what Ahmed’s interests are so that we can better
design a user experience for him. Through his purchasing decisions, we
find out that Ahmed likes robots, opera, and motorcycles. We’ll store
that information in a set inside of our map:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">SetUpdate</span> <span class="n">su</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SetUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"robots"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"opera"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"motorcycles"</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">mu</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"interests"</span><span class="o">,</span> <span class="n">su</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">mu</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="sx">%{ robots opera motorcycles }</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">interest</span><span class="o">|</span>
    <span class="n">m</span><span class="p">.</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'interests'</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="n">interest</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateSet</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateSet</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'robots'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'opera'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'motorcycles'</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateSet</span><span class="p">(</span><span class="s1">'interests'</span><span class="p">,</span> <span class="nv">$updateSet</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">interest</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'robots'</span><span class="p">,</span> <span class="s">'opera'</span><span class="p">,</span> <span class="s">'motorcycles'</span><span class="p">]:</span>
    <span class="nb">map</span><span class="p">.</span><span class="n">sets</span><span class="p">[</span><span class="s">'interests'</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="n">interest</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">interestsAdds</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"robots"</span><span class="p">,</span> <span class="s">"opera"</span><span class="p">,</span> <span class="s">"motorcycles"</span> <span class="p">};</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">AddToSet</span><span class="p">(</span><span class="s">"interests"</span><span class="p">,</span> <span class="n">interestsAdds</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>
<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">RiakResult</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="n">MapResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>

<span class="c1">// Map: {"Counters":{"page_visits":3},</span>
         <span class="s">"Sets"</span><span class="p">:{</span><span class="s">"interests"</span><span class="p">:[</span><span class="s">"motorcycles"</span><span class="p">,</span><span class="s">"opera"</span><span class="p">,</span><span class="s">"robots"</span><span class="p">]},</span>
         <span class="s">"Registers"</span><span class="p">:{</span><span class="s">"first_name"</span><span class="p">:</span><span class="s">"Ahmed"</span><span class="p">,</span><span class="s">"phone_number"</span><span class="p">:</span><span class="s">"5551234567"</span><span class="p">},</span>
         <span class="s">"Flags"</span><span class="p">:{</span><span class="s">"enterprise_customer"</span><span class="p">:</span><span class="k">false</span><span class="p">},</span>
         <span class="s">"Maps"</span><span class="p">:{}}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">addToSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">robots</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">addToSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">opera</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">addToSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">motorcycles</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map4</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"robots"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Map3</span><span class="p">),</span>
<span class="nv">Map5</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"opera"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map4</span><span class="p">),</span>
<span class="nv">Map6</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"motorcycles"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map4</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "interests_set": {
        "add_all": [
          "robots",
          "opera",
          "motorcycles"
        ]
      }
    }
  }'
</code></pre>

<p>We can then verify that the <code class="language-plaintext highlighter-rouge">interests</code> set includes these three
interests:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">FetchMap</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchMap</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="nc">RiakMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getDatatype</span><span class="o">();</span>
<span class="nc">RiakSet</span> <span class="n">interestSet</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getSet</span><span class="o">(</span><span class="s">"interests"</span><span class="o">);</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BinaryValue</span><span class="o">&gt;</span> <span class="n">interests</span> <span class="o">=</span> <span class="n">interestSet</span><span class="o">.</span><span class="na">view</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">interests</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="nc">BinaryValue</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"robots"</span><span class="o">)));</span>

<span class="c1">// Checking for "opera" and "motorcycles" works the same way</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="sx">%w{ robots opera motorcycles }</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">interest</span><span class="o">|</span>
    <span class="n">m</span><span class="p">.</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'interests'</span><span class="p">].</span><span class="nf">include?</span> <span class="n">interest</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># This will return three Boolean values</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$map</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\FetchMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">();</span>

<span class="nv">$sets</span> <span class="o">=</span> <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getSet</span><span class="p">(</span><span class="s1">'interests'</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$sets</span><span class="o">-&gt;</span><span class="nf">getData</span><span class="p">());</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reloaded_map</span> <span class="o">=</span> <span class="nb">map</span><span class="p">.</span><span class="nb">reload</span><span class="p">()</span>
<span class="k">for</span> <span class="n">interest</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'robots'</span><span class="p">,</span> <span class="s">'opera'</span><span class="p">,</span> <span class="s">'motorcycles'</span><span class="p">]:</span>
    <span class="n">interest</span> <span class="ow">in</span> <span class="n">reloaded_map</span><span class="p">.</span><span class="n">sets</span><span class="p">[</span><span class="s">'interests'</span><span class="p">].</span><span class="n">value</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="n">Map</span> <span class="n">ahmedMap</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>

<span class="c1">// All of the following return true:</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"robots"</span><span class="p">);</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"opera"</span><span class="p">);</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"motorcycles"</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">assert</span><span class="p">(</span><span class="nx">rslt</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">sets</span><span class="p">[</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">robots</span><span class="dl">'</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">riakc_map</span><span class="p">:</span><span class="nf">dirty_value</span><span class="p">(</span><span class="nv">Map6</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info?include_context=false
</code></pre>

<p>We learn from a recent purchasing decision that Ahmed actually doesn’t
seem to like opera. He’s much more keen on indie pop. Let’s change the
<code class="language-plaintext highlighter-rouge">interests</code> set to reflect that:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">SetUpdate</span> <span class="n">su</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SetUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"opera"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"indie pop"</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">mu</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"interests"</span><span class="o">,</span> <span class="n">su</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">mu</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'interests'</span><span class="p">].</span><span class="nf">remove</span><span class="p">(</span><span class="s1">'opera'</span><span class="p">)</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'interests'</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="s1">'indie pop'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateSet</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateSet</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'indie pop'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">remove</span><span class="p">(</span><span class="s1">'opera'</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateSet</span><span class="p">(</span><span class="s1">'interests'</span><span class="p">,</span> <span class="nv">$updateSet</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withContext</span><span class="p">(</span><span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getContext</span><span class="p">())</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">sets</span><span class="p">[</span><span class="s">'interests'</span><span class="p">].</span><span class="n">discard</span><span class="p">(</span><span class="s">'opera'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">sets</span><span class="p">[</span><span class="s">'interests'</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="s">'indie pop'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">AddToSet</span><span class="p">(</span><span class="s">"interests"</span><span class="p">,</span> <span class="s">"indie pop"</span><span class="p">);</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">RemoveFromSet</span><span class="p">(</span><span class="s">"interests"</span><span class="p">,</span> <span class="s">"opera"</span><span class="p">);</span>

<span class="n">builder</span>
    <span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>

<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">RiakResult</span> <span class="n">rslt</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="n">MapResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
<span class="n">Map</span> <span class="n">ahmedMap</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>

<span class="c1">// This is false</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"opera"</span><span class="p">);</span>

<span class="c1">// These are true</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"indie pop"</span><span class="p">);</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"robots"</span><span class="p">);</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Sets</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"interests"</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"motorcycles"</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
    <span class="nx">mapOp</span><span class="p">.</span><span class="nx">removeFromSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">opera</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">mapOp</span><span class="p">.</span><span class="nx">addToSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">indie pop</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">options</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">op</span> <span class="o">=</span> <span class="nx">mapOp</span><span class="p">;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map7</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">del_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"opera"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Map6</span><span class="p">),</span>
<span class="nv">Map8</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
                        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"indie pop"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                        <span class="nv">Map7</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info

# Response
{"type":"map","value":{"enterprise_customer_flag":false,"first_name_register":"Ahmed","interests_set":["motorcycles","opera","robots"],"page_visits_counter":1,"phone_number_register":"5551234567"},"context":"g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEEag=="}

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "interests_set": {
        "remove": "opera",
        "add": "indie pop"
      }
    },
    "context" : "g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEEag=="
  }
  '
</code></pre>

<h2 id="maps-within-maps">Maps Within Maps</h2>

<p>We’ve stored a wide of variety of information—of a wide variety of
types—within the <code class="language-plaintext highlighter-rouge">ahmed_info</code> map thus far, but we have yet to explore
recursively storing maps within maps (which can be nested as deeply as
you wish).</p>

<p>Our company is doing well and we have lots of useful information about
Ahmed, but now we want to store information about Ahmed’s contacts as
well. We’ll start with storing some information about Ahmed’s colleague
Annika inside of a map called <code class="language-plaintext highlighter-rouge">annika_info</code>.</p>

<p>First, we’ll store Annika’s first name, last name, and phone number in
registers:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">RegisterUpdate</span> <span class="n">ru1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="s">"Annika"</span><span class="o">);</span>
<span class="nc">RegisterUpdate</span> <span class="n">ru2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="s">"Weiss"</span><span class="o">);</span>
<span class="nc">RegisterUpdate</span> <span class="n">ru3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="s">"5559876543"</span><span class="o">);</span>

<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"first_name"</span><span class="o">,</span> <span class="n">ru1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"last_name"</span><span class="o">,</span> <span class="n">ru2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"phone_number"</span><span class="o">,</span> <span class="n">ru3</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'first_name'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Annika'</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'last_name'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Weiss'</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'phone_number'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5559876543</span><span class="p">.</span><span class="nf">to_s</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">,</span> <span class="s1">'Annika'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'last_name'</span><span class="p">,</span> <span class="s1">'Weiss'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'phone_number'</span><span class="p">,</span> <span class="s1">'5559876543'</span><span class="p">);</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withParameter</span><span class="p">(</span><span class="s1">'returnbody'</span><span class="p">,</span> <span class="s1">'true'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">registers</span><span class="p">[</span><span class="s">'first_name'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="s">'Annika'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">registers</span><span class="p">[</span><span class="s">'last_name'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="s">'Weiss'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">registers</span><span class="p">[</span><span class="s">'phone_number'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">5559876543</span><span class="p">))</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">annikaInfoOperation</span> <span class="p">=</span> <span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">);</span>
<span class="n">annikaInfoOperation</span><span class="p">.</span><span class="nf">SetRegister</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">,</span> <span class="s">"Annika"</span><span class="p">);</span>
<span class="n">annikaInfoOperation</span><span class="p">.</span><span class="nf">SetRegister</span><span class="p">(</span><span class="s">"last_name"</span><span class="p">,</span> <span class="s">"Weiss"</span><span class="p">);</span>
<span class="n">annikaInfoOperation</span><span class="p">.</span><span class="nf">SetRegister</span><span class="p">(</span><span class="s">"phone_number"</span><span class="p">,</span> <span class="s">"5559876543"</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>
<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">first_name</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Annika</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">last_name</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Weiss</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">phone_number</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">5559876543</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">options</span><span class="p">.</span><span class="nx">op</span> <span class="o">=</span> <span class="nx">mapOp</span><span class="p">;</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map12</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"first_name"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">register</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_register</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"Annika"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">R</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map11</span><span class="p">),</span>
<span class="nv">Map13</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"last_name"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">register</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_register</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"Weiss"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">R</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map12</span><span class="p">),</span>
<span class="nv">Map14</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"phone_number"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">register</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_register</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"5559876543"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">R</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map13</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "update": {
          "first_name_register": "Annika",
          "last_name_register": "Weiss",
          "phone_number_register": "5559876543"
        }
      }
    }
  }
  '
</code></pre>

<p>The value of a register in a map can be obtained without a special
method:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">FetchMap</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchMap</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">annikaFirstName</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getDatatype</span><span class="o">()</span>
        <span class="o">.</span><span class="na">getMap</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getRegister</span><span class="o">(</span><span class="s">"first_name"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">view</span><span class="o">()</span>
        <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">registers</span><span class="p">[</span><span class="s1">'first_name'</span><span class="p">]</span>

<span class="c1"># "Annika"</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># with param 'returnbody' = 'true', we can fetch the map from our last response</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">();</span>

<span class="k">echo</span> <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getRegister</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">);</span> <span class="c1">// Annika</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="nb">reload</span><span class="p">().</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">registers</span><span class="p">[</span><span class="s">'first_name'</span><span class="p">].</span><span class="n">value</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="n">ahmedMap</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Maps</span><span class="p">[</span><span class="s">"annika_info"</span><span class="p">].</span><span class="n">Registers</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">annikaFirstName</span> <span class="o">=</span>
        <span class="nx">rslt</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">maps</span><span class="p">[</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">].</span><span class="nx">registers</span><span class="p">[</span><span class="dl">'</span><span class="s1">first_name</span><span class="dl">'</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">riakc_map</span><span class="p">:</span><span class="nf">dirty_value</span><span class="p">(</span><span class="nv">Map14</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl"># Specific values for fields inside of maps (or maps within maps, for that
# matter), cannot be obtained directly through the HTTP interface.
</code></pre>

<p>Registers can also be removed:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This example uses our "ahmedMap" location from above. Operations that</span>
<span class="c1">// remove fields from maps require that you first fetch the opaque context</span>
<span class="c1">// attached to the map and then include the context in the update operation:</span>

<span class="nc">FetchMap</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchMap</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="nc">Context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">removeRegister</span><span class="o">(</span><span class="s">"first_name"</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withContext</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">registers</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">removeRegister</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withContext</span><span class="p">(</span><span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getContext</span><span class="p">())</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">del</span> <span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">registers</span><span class="p">[</span><span class="s">'first_name'</span><span class="p">]</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">).</span><span class="nf">RemoveRegister</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">);</span>

<span class="c1">// Note: using Context from last response</span>
<span class="n">builder</span>
    <span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>

<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
    <span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">).</span><span class="nx">removeRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">first_name</span><span class="dl">'</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span><span class="p">,</span>
        <span class="na">context</span><span class="p">:</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map15</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
                         <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nb">erase</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">"phone_number"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">register</span><span class="p">},</span> <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
                         <span class="nv">Map14</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info

# Response
{"type":"map","value":{"annika_info_map":{"first_name_register":"Annika","last_name_register":"Weiss","phone_number_register":"5559876543"},"enterprise_customer_flag":false,"first_name_register":"Ahmed","interests_set":["indie pop","motorcycles","robots"],"page_visits_counter":1,"phone_number_register":"5551234567"},"context":"g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEGag=="}

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "remove": ["phone_number_register"]
      }
    },
    "context" : "g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEGag=="
  }
  '
</code></pre>

<p>Now, we’ll store whether Annika is subscribed to a variety of plans
within the company as well:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">FetchMap</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchMap</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="nc">Context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"enterprise_plan"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">((</span><span class="kc">false</span><span class="o">))</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"family_plan"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"free_plan"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withContext</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'enterprise_plan'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'family_plan'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'free_plan'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateFlag</span><span class="p">(</span><span class="s1">'enterprise_plan'</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateFlag</span><span class="p">(</span><span class="s1">'family_plan'</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateFlag</span><span class="p">(</span><span class="s1">'free_plan'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withParameter</span><span class="p">(</span><span class="s1">'returnbody'</span><span class="p">,</span> <span class="s1">'true'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">flags</span><span class="p">[</span><span class="s">'enterprise_plan'</span><span class="p">].</span><span class="n">disable</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">flags</span><span class="p">[</span><span class="s">'family_plan'</span><span class="p">].</span><span class="n">disable</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">flags</span><span class="p">[</span><span class="s">'free_plan'</span><span class="p">].</span><span class="n">enable</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">SetFlag</span><span class="p">(</span><span class="s">"enterprise_plan"</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">SetFlag</span><span class="p">(</span><span class="s">"family_plan"</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">SetFlag</span><span class="p">(</span><span class="s">"free_plan"</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>

<span class="n">MapUpdate</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">annika_map</span> <span class="o">=</span> <span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">annika_map</span><span class="p">.</span><span class="nx">setFlag</span><span class="p">(</span><span class="dl">'</span><span class="s1">enterprise_plan</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">annika_map</span><span class="p">.</span><span class="nx">setFlag</span><span class="p">(</span><span class="dl">'</span><span class="s1">family_plan</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">annika_map</span><span class="p">.</span><span class="nx">setFlag</span><span class="p">(</span><span class="dl">'</span><span class="s1">free_plan</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span><span class="p">,</span>
        <span class="na">context</span><span class="p">:</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map16</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"enterprise_plan"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">flag</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_flag</span><span class="p">:</span><span class="nf">disable</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map15</span><span class="p">),</span>
<span class="nv">Map17</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"family_plan"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">flag</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_flag</span><span class="p">:</span><span class="nf">disable</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map16</span><span class="p">),</span>
<span class="nv">Map18</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"free_plan"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">flag</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_flag</span><span class="p">:</span><span class="nf">enable</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map17</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info

# Response
{"type":"map","value":{"annika_info_map":{"first_name_register":"Annika","last_name_register":"Weiss"},"enterprise_customer_flag":false,"first_name_register":"Ahmed","interests_set":["indie pop","motorcycles","robots"],"page_visits_counter":1,"phone_number_register":"5551234567"},"context":"g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEHag=="}

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "update": {
          "enterprise_plan_flag": "disable",
          "family_plan_flag": "disable",
          "free_plan_flag": "enable"
        }
      }
    },
    "context" : "g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEHag=="
  }
  '
</code></pre>

<p>The value of a flag can be retrieved at any time:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">FetchMap</span> <span class="n">fetch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FetchMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="nc">FetchMap</span><span class="o">.</span><span class="na">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">fetch</span><span class="o">);</span>
<span class="kt">boolean</span> <span class="n">enterprisePlan</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getDatatype</span><span class="o">()</span>
        <span class="o">.</span><span class="na">getMap</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getFlag</span><span class="o">(</span><span class="s">"enterprise_plan"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">view</span><span class="o">();</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'enterprise_plan'</span><span class="p">]</span>

<span class="c1"># false</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># with param 'returnbody' = 'true', we can fetch the map from our last response</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">();</span>

<span class="k">echo</span> <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getFlag</span><span class="p">(</span><span class="s1">'enterprise_plan'</span><span class="p">);</span> <span class="c1">// false</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="nb">reload</span><span class="p">().</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">flags</span><span class="p">[</span><span class="s">'enterprise_plan'</span><span class="p">].</span><span class="n">value</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="n">ahmedMap</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="n">ahmedMap</span><span class="p">.</span><span class="n">Maps</span><span class="p">[</span><span class="s">"annika_info"</span><span class="p">].</span><span class="n">Flags</span><span class="p">[</span><span class="s">"enterprise_plan"</span><span class="p">];</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">enterprisePlan</span> <span class="o">=</span>
        <span class="nx">rslt</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">annika_info</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">enterprise_plan</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">riakc_map</span><span class="p">:</span><span class="nf">dirty_value</span><span class="p">(</span><span class="nv">Map18</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl"># Specific values for fields inside of maps (or maps within maps, for that
# matter), cannot be obtained directly through the HTTP interface.
</code></pre>

<p>It’s also important to track the number of purchases that Annika has
made with our company. Annika just made her first widget purchase:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"widget_purchases"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">CounterUpdate</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">counters</span><span class="p">[</span><span class="s1">'widget_purchases'</span><span class="p">].</span><span class="nf">increment</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateCounter</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\IncrementCounter</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">withIncrement</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateCounter</span><span class="p">(</span><span class="s1">'widget_purchases'</span><span class="p">,</span> <span class="nv">$updateCounter</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">counters</span><span class="p">[</span><span class="s">'widget_purchases'</span><span class="p">].</span><span class="n">increment</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">).</span><span class="nf">IncrementCounter</span><span class="p">(</span><span class="s">"widget_purchases"</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>

<span class="n">UpdateMap</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">).</span><span class="nx">incrementCounter</span><span class="p">(</span><span class="dl">'</span><span class="s1">widget_purchases</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map19</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"widget_purchases"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">counter</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_counter</span><span class="p">:</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map18</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "update": {
          "widget_purchases_counter": 1
        }
      }
    }
  }
  '
</code></pre>

<p>Now let’s store Annika’s interests in a set:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">SetUpdate</span> <span class="n">su</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SetUpdate</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"tango dancing"</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"interests"</span><span class="o">,</span> <span class="n">su</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'interests'</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="s1">'tango dancing'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateSet</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateSet</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'tango dancing'</span><span class="p">);</span>

<span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateSet</span><span class="p">(</span><span class="s1">'interests'</span><span class="p">,</span> <span class="nv">$updateSet</span><span class="p">);</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withParameter</span><span class="p">(</span><span class="s1">'returnbody'</span><span class="p">,</span> <span class="s1">'true'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">sets</span><span class="p">[</span><span class="s">'interests'</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="s">'tango dancing'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">).</span><span class="nf">AddToSet</span><span class="p">(</span><span class="s">"interests"</span><span class="p">,</span> <span class="s">"tango dancing"</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">());</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">annika_map</span> <span class="o">=</span> <span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">annika_map</span><span class="p">.</span><span class="nx">addToSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">tango dancing</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map20</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"tango dancing"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map19</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "update": {
          "interests_set": {
            "add": "tango dancing"
          }
        }
      }
    }
  }
  '
</code></pre>

<p>We can remove that interest in just the way that we would expect:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">SetUpdate</span> <span class="n">su</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SetUpdate</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="s">"tango dancing"</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"interests"</span><span class="o">,</span> <span class="n">su</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUpdate</span><span class="o">(</span><span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'interests'</span><span class="p">].</span><span class="nf">remove</span><span class="p">(</span><span class="s1">'tango dancing'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateSet</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateSet</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">remove</span><span class="p">(</span><span class="s1">'tango dancing'</span><span class="p">);</span>

<span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateSet</span><span class="p">(</span><span class="s1">'interests'</span><span class="p">,</span> <span class="nv">$updateSet</span><span class="p">);</span>

<span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withContext</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getMap</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getContext</span><span class="p">())</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">sets</span><span class="p">[</span><span class="s">'interests'</span><span class="p">].</span><span class="n">discard</span><span class="p">(</span><span class="s">'tango dancing'</span><span class="p">)</span>
<span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">).</span><span class="nf">RemoveFromSet</span><span class="p">(</span><span class="s">"interests"</span><span class="p">,</span> <span class="s">"tango dancing"</span><span class="p">);</span>

<span class="c1">// Note: using Context from previous response</span>
<span class="n">builder</span>
    <span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">());</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">fetchMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">annika_map</span> <span class="o">=</span> <span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">annika_map</span><span class="p">.</span><span class="nx">removeFromSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">interests</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">tango dancing</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span><span class="p">,</span>
        <span class="na">context</span><span class="p">:</span> <span class="nx">rslt</span><span class="p">.</span><span class="nx">context</span>
    <span class="p">};</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map21</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"interests"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">set</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_set</span><span class="p">:</span><span class="nf">del_element</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">"tango dancing"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map20</span><span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info

# Response
{"type":"map","value":{"annika_info_map":{"enterprise_plan_flag":false,"family_plan_flag":false,"first_name_register":"Annika","free_plan_flag":true,"interests_set":["tango dancing"],"last_name_register":"Weiss","widget_purchases_counter":1},"enterprise_customer_flag":false,"first_name_register":"Ahmed","interests_set":["indie pop","motorcycles","robots"],"page_visits_counter":1,"phone_number_register":"5551234567"},"context":"g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEKag=="}

curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "update": {
          "interests_set": {
            "remove": "tango dancing"
          }
        }
      }
    },
    "context" : "g2wAAAABaAJtAAAADCMJ/vn2jOEXAAAAAWEKag=="
  }
  '
</code></pre>

<p>If we wanted to add store information about one of Annika’s specific
purchases, we could do so within a map:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using our "ahmedMap" location from above:</span>

<span class="nc">MapUpdate</span> <span class="n">purchaseUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"first_purchase"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FlagUpdate</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"amount"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RegisterUpdate</span><span class="o">(</span><span class="s">"1271"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"items"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SetUpdate</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"large widget"</span><span class="o">));</span>
<span class="nc">MapUpdate</span> <span class="n">annikaUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"purchase"</span><span class="o">,</span> <span class="n">purchaseUpdate</span><span class="o">);</span>
<span class="nc">MapUpdate</span> <span class="n">ahmedUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapUpdate</span><span class="o">()</span>
        <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"annika_info"</span><span class="o">,</span> <span class="n">annikaUpdate</span><span class="o">);</span>
<span class="nc">UpdateMap</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ahmedMap</span><span class="o">,</span> <span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUpdate</span><span class="o">(</span><span class="n">ahmedUpdate</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="p">.</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'annika_info'</span><span class="p">].</span><span class="nf">maps</span><span class="p">[</span><span class="s1">'purchase'</span><span class="p">].</span><span class="nf">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">flags</span><span class="p">[</span><span class="s1">'first_purchase'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">register</span><span class="p">[</span><span class="s1">'amount'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1271</span><span class="p">.</span><span class="nf">to_s</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">sets</span><span class="p">[</span><span class="s1">'items'</span><span class="p">].</span><span class="nf">add</span><span class="p">(</span><span class="s1">'large widget'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$updateSet</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateSet</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'large widget'</span><span class="p">);</span>

<span class="nv">$purchaseMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateFlag</span><span class="p">(</span><span class="s1">'first_purchase'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateRegister</span><span class="p">(</span><span class="s1">'amount'</span><span class="p">,</span> <span class="s1">'1271'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">updateSet</span><span class="p">(</span><span class="s1">'items'</span><span class="p">,</span> <span class="nv">$updateSet</span><span class="p">);</span>

<span class="nv">$annikaMap</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'purchase'</span><span class="p">,</span> <span class="nv">$purchaseMap</span><span class="p">);</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="err">\</span><span class="nf">Basho\Riak\Command\Builder\UpdateMap</span><span class="p">(</span><span class="nv">$riak</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">updateMap</span><span class="p">(</span><span class="s1">'annika_info'</span><span class="p">,</span> <span class="nv">$annikaMap</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">atLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withParameter</span><span class="p">(</span><span class="s1">'returnbody'</span><span class="p">,</span> <span class="s1">'true'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">build</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">maps</span><span class="p">[</span><span class="s">'purchase'</span><span class="p">].</span><span class="n">flags</span><span class="p">[</span><span class="s">'first_purchase'</span><span class="p">].</span><span class="n">enable</span><span class="p">()</span>
<span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">maps</span><span class="p">[</span><span class="s">'purchase'</span><span class="p">].</span><span class="n">register</span><span class="p">[</span><span class="s">'amount'</span><span class="p">].</span><span class="n">assign</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">1271</span><span class="p">))</span>
<span class="nb">map</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="s">'annika_info'</span><span class="p">].</span><span class="n">maps</span><span class="p">[</span><span class="s">'purchase'</span><span class="p">].</span><span class="n">sets</span><span class="p">[</span><span class="s">'items'</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="s">'large widget'</span><span class="p">)</span>
<span class="c1"># and so on
</span><span class="nb">map</span><span class="p">.</span><span class="n">store</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://github.com/basho/riak-dotnet-client/blob/develop/src/RiakClientExamples/Dev/Using/DataTypes.cs</span>

<span class="kt">var</span> <span class="n">mapOperation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UpdateMap</span><span class="p">.</span><span class="nf">MapOperation</span><span class="p">();</span>
<span class="n">mapOperation</span><span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="s">"annika_info"</span><span class="p">).</span><span class="nf">Map</span><span class="p">(</span><span class="s">"purchase"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">SetFlag</span><span class="p">(</span><span class="s">"first_purchase"</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">SetRegister</span><span class="p">(</span><span class="s">"amount"</span><span class="p">,</span> <span class="s">"1271"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">AddToSet</span><span class="p">(</span><span class="s">"items"</span><span class="p">,</span> <span class="s">"large widget"</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">WithMapOperation</span><span class="p">(</span><span class="n">mapOperation</span><span class="p">);</span>
<span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">());</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mapOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Riak</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">CRDT</span><span class="p">.</span><span class="nx">UpdateMap</span><span class="p">.</span><span class="nx">MapOperation</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">annika_map</span> <span class="o">=</span> <span class="nx">mapOp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">annika_info</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">annika_purchase_map</span> <span class="o">=</span> <span class="nx">annika_map</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">purchase</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">annika_purchase_map</span><span class="p">.</span><span class="nx">setFlag</span><span class="p">(</span><span class="dl">'</span><span class="s1">first_purchase</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">annika_purchase_map</span><span class="p">.</span><span class="nx">setRegister</span><span class="p">(</span><span class="dl">'</span><span class="s1">amount</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">1271</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">annika_purchase_map</span><span class="p">.</span><span class="nx">addToSet</span><span class="p">(</span><span class="dl">'</span><span class="s1">items</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">large widget</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">bucketType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">maps</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ahmed_info</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">op</span><span class="p">:</span> <span class="nx">mapOp</span>
<span class="p">};</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rslt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Map22</span> <span class="o">=</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
    <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"annika_info"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
        <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"purchase"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">map</span><span class="p">},</span>
        <span class="k">fun</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_map</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span>
            <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"first_purchase"</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">flag</span><span class="p">},</span>
            <span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">riakc_flag</span><span class="p">:</span><span class="nf">enable</span><span class="p">(</span><span class="nv">R</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">M</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">Map21</span>
<span class="p">).</span>
</code></pre></div></div>

<pre><code class="language-curl">curl -XPOST http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info \
  -H "Content-Type: application/json" \
  -d '
  {
    "update": {
      "annika_info_map": {
        "update": {
          "purchase_map": {
            "update": {
              "first_purchase_flag": "enable",
              "amount_register": "1271",
              "items_set": {
                "add": "large widget"
              }
            }
          }
        }
      }
    }
  }
  '
</code></pre>
